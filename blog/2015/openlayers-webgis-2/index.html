<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Gábor Farkas | WebGIS application with OpenLayers 2 - Part 2: Map controls</title>
  <meta name="description" content="My personal site.">

  <link rel="shortcut icon" href="https://gaborfarkas.github.io/assets/img/favicon.ico">

  <link rel="stylesheet" href="https://gaborfarkas.github.io/assets/css/main.css">
  <link rel="canonical" href="https://gaborfarkas.github.io/blog/2015/openlayers-webgis-2/">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    
    <span class="site-title">
        
        Gábor Farkas
    </span>
    

    <nav class="site-nav">

      <div class="trigger">
        <!-- About -->
        <a class="page-link" href="https://gaborfarkas.github.io/">about</a>

        <!-- Blog -->
        <a class="page-link" href="https://gaborfarkas.github.io/blog/">blog</a>

        <!-- Pages -->
        
          
        
          
            <a class="page-link" href="https://gaborfarkas.github.io/cv/">CV</a>
          
        
          
        
          
        
          
            <a class="page-link" href="https://gaborfarkas.github.io/publications/">publications</a>
          
        
          
            <a class="page-link" href="https://gaborfarkas.github.io/stuff/">stuff</a>
          
        
          
        
          
        
          
        

      </div>
    </nav>

  </div>

</header>



    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">WebGIS application with OpenLayers 2 - Part 2: Map controls</h1>
    <p class="post-meta">March 4, 2015</p>
  </header>

  <article class="post-content">
    <style type="text/css">
tbody {
    vertical-align: top;
}
#layerControl_wrap img {
    padding: 0px;
}
#layerControl_wrap {
    width: 200px;
    max-height: 500px;
    overflow: auto;
    padding: 0px;
}
#layerControl_wrap p {
    width: 100px;
    word-break: break-all;
    display: inline-table;
}
#layerControl_wrap input {
    width: 20px;
    height: 20px;
    margin: 0px 0px 0px 4px;
}
#layerControl_wrap input[type=button] {
    position: relative;
    bottom: 3px;
}
.olControlPanel .olButton {
    top: 5px;
    position: relative;
    left: 100px;
    background-repeat: no-repeat;
    background-color: #EBEBE6;
    margin: 0 0 5px 5px;
    width: 24px;
    height: 22px;
    cursor: pointer;
    float: left;
    border-radius: 5px 5px 5px 5px;
    border: 1px grey solid;
}
.olControlPanel .olControlZoomToMaxExtentItemInactive { 
    background-image: url("http://openlayers.org/api/img/zoom-world-mini.png");
    background-size: contain;
}
.olControlPanel .olControlNavigationHistory {
    background-image: url("http://openlayers.org/api/theme/default/img/navigation_history.png");
}
    .olControlPanel .olControlMeasureItemActive {
        background-image: url("http://openlayers.org/api/img/measuring-stick-on.png");
        background-size: contain;
        background-position: 1px 0px;
    }
    .olControlPanel .olControlMeasureItemInactive {
        background-image: url("http://openlayers.org/api/img/measuring-stick-off.png");
        background-size: contain;
        background-position: 1px 0px;
    }
    .olControlPanel .olControlGraticuleItemActive {
        background-image: url("http://seadas.gsfc.nasa.gov/help/visat/images/icons/GraticuleOverlay24.gif");
        background-size: contain;
        filter: hue-rotate(180deg);
        -webkit-filter: hue-rotate(180deg);
    }
    .olControlPanel .olControlGraticuleItemInactive {
        background-image: url("http://seadas.gsfc.nasa.gov/help/visat/images/icons/GraticuleOverlay24.gif");
        background-size: contain;
    }
    .olControlEditingToolbar .olControlModifyFeatureItemActive { 
        background-image: url("http://junichi11.com/wp-content/uploads/2011/01/tool-node-editor.png");
        background-size: contain;
        filter: hue-rotate(180deg);
        -webkit-filter: hue-rotate(180deg);
    }
    .olControlEditingToolbar .olControlModifyFeatureItemInactive { 
        background-image: url("http://junichi11.com/wp-content/uploads/2011/01/tool-node-editor.png");
        background-size: contain;
    }
    .olControlEditingToolbar .olControlDragFeatureItemActive { 
        background-image: url("http://openlayers.org/api/theme/default/img/move_feature_on.png");
    }
    .olControlEditingToolbar .olControlDragFeatureItemInactive { 
        background-image: url("http://openlayers.org/api/theme/default/img/move_feature_off.png");
    }
    .olControlEditingToolbar .olControlDeleteFeatureItemActive { 
        background-image: url("http://openlayers.org/api/theme/default/img/remove_point_on.png");
    }
    .olControlEditingToolbar .olControlDeleteFeatureItemInactive { 
        background-image: url("http://openlayers.org/api/theme/default/img/remove_point_off.png");
    }
    .olControlEditingToolbar .olControlSnappingItemActive { 
        background-image: url("http://tavmjong.free.fr/INKSCAPE/MANUAL/images/ICONS_PNG/status/snap.png");
        background-size: contain;
        filter: hue-rotate(180deg);
        -webkit-filter: hue-rotate(180deg);
    }
    .olControlEditingToolbar .olControlSnappingItemInactive { 
        background-image: url("http://tavmjong.free.fr/INKSCAPE/MANUAL/images/ICONS_PNG/status/snap.png");
        background-size: contain;
    }
    .menuToggle {
        width: 100px;
        float: left;
        cursor: pointer;
        -moz-appearance: button;
        -moz-user-select: none;
        -webkit-appearance: button;
        -webkit-user-select: none;
    }
    .menuContent {
        list-style: none;
        position: absolute;
        width: inherit;
    }
    .menuContent div {
        border: 1px solid black;
        cursor: default;
        background-color: #FFFFFF;
        position: relative;
        z-index: 9999;
        border-top-width: 0px;
    }
    .menuContent div:hover {
        background-color: #CEE3F6;
    }
svg {
        max-height: initial;
    }
</style>

<p>So far we have created the basic container for a web mapping application GUI. The key aspect in a good application is user experience. This mostly depends on how easily a user can utilize the application, and how smoothly can accomplish a workflow. For a decent user experience, one should think as a user when designing the appearance and mechanics of the application. To make things go right in a WebGIS application powered by OpenLayers 2, the library offers a wide variety of controls. As developers, the responsibility is on us, if we get the most out of it, or not. This is the part where OpenLayers 2 shows its advantages even against its successor. The following post will demonstrate how we can extend our application with minimal programming, and mostly controls offered by OpenLayers 2.</p>

<h3 id="the-html-and-css-part">The HTML and CSS part</h3>

<p>The basic appearance of the application is defined in the OpenLayers 2 library, however, if we want to extend it with custom items, it has to be done in HTML and CSS. One can work with any of the more or less popular frameworks, but I used pure HTML and CSS for the sake of clarity. In HTML there are two new mechanisms: a menu bar and input forms. The menu bar consists of simple div elements, while the input forms are form elements wrapped in divs. In the CSS part, I defined some styles for these elements, plus added some icons for the new control buttons. The stylesheet looks like the following:</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code>.olControlPanel .olControlMeasureItemInactive {
    background-image: url("../../OpenLayers-2.13.1/img/measuring-stick-off.png");
    background-size: contain;
    background-position: 1px 0px;
}
.olControlPanel .olControlGraticuleItemActive {
    background-image: url("http://seadas.gsfc.nasa.gov/help/visat/images/icons/GraticuleOverlay24.gif");
    background-size: contain;
    filter: hue-rotate(180deg);
    -webkit-filter: hue-rotate(180deg);
}
.olControlPanel .olControlGraticuleItemInactive {
    background-image: url("http://seadas.gsfc.nasa.gov/help/visat/images/icons/GraticuleOverlay24.gif");
    background-size: contain;
}
.olControlEditingToolbar .olControlModifyFeatureItemActive { 
    background-image: url("http://junichi11.com/wp-content/uploads/2011/01/tool-node-editor.png");
    background-size: contain;
    filter: hue-rotate(180deg);
    -webkit-filter: hue-rotate(180deg);
}
.olControlEditingToolbar .olControlModifyFeatureItemInactive { 
    background-image: url("http://junichi11.com/wp-content/uploads/2011/01/tool-node-editor.png");
    background-size: contain;
}
.olControlEditingToolbar .olControlDragFeatureItemActive { 
    background-image: url("../../OpenLayers-2.13.1/theme/default/img/move_feature_on.png");
}
.olControlEditingToolbar .olControlDragFeatureItemInactive { 
    background-image: url("../../OpenLayers-2.13.1/theme/default/img/move_feature_off.png");
}
.olControlEditingToolbar .olControlDeleteFeatureItemActive { 
    background-image: url("../../OpenLayers-2.13.1/theme/default/img/remove_point_on.png");
}
.olControlEditingToolbar .olControlDeleteFeatureItemInactive { 
    background-image: url("../../OpenLayers-2.13.1/theme/default/img/remove_point_off.png");
}
.olControlEditingToolbar .olControlSnappingItemActive { 
    background-image: url("http://tavmjong.free.fr/INKSCAPE/MANUAL/images/ICONS_PNG/status/snap.png");
    background-size: contain;
    filter: hue-rotate(180deg);
    -webkit-filter: hue-rotate(180deg);
}
.olControlEditingToolbar .olControlSnappingItemInactive { 
    background-image: url("http://tavmjong.free.fr/INKSCAPE/MANUAL/images/ICONS_PNG/status/snap.png");
    background-size: contain;
}
.menuToggle {
    width: 100px;
    float: left;
    cursor: pointer;
    -moz-appearance: button;
    -moz-user-select: none;
    -webkit-appearance: button;
    -webkit-user-select: none;
}
.menuContent {
    list-style: none;
    position: absolute;
    width: inherit;
}
.menuContent div {
    border: 1px solid black;
    cursor: default;
    background-color: #FFFFFF;
    position: relative;
    z-index: 9999;
    border-top-width: 0px;
}
.menuContent div:hover {
    background-color: #CEE3F6;
}
</code></pre>
</div>

<p>As you can see, the styles of the controls buttons are nested into the appropriate container styles. Without this step, the buttons don’t get rendered correctly. Also, I used some experimental attributes, like <code class="highlighter-rouge">filter</code> and <code class="highlighter-rouge">appearance</code>. These experimental attributes have to be defined for every browser engine differently. The <code class="highlighter-rouge">-moz</code> and <code class="highlighter-rouge">-webkit</code> prefixes are the engine specific definitions, and they represent the Gecko (Mozilla products), and the WebKit/Blink (used by Chrome, Opera, and Safari) engines.</p>

<p>The HTML part of my code looks like this:</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"menu_new"</span> <span class="na">class=</span><span class="s">"menuToggle"</span><span class="nt">&gt;</span> New
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"menu_new_content"</span> <span class="na">class=</span><span class="s">"menuContent"</span> <span class="na">style=</span><span class="s">"display: none;"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">data-dialog=</span><span class="s">"new_wms"</span> <span class="na">onclick=</span><span class="s">"openDialog(this)"</span><span class="nt">&gt;</span>WMS Layer<span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">data-dialog=</span><span class="s">"new_wfs"</span> <span class="na">onclick=</span><span class="s">"openDialog(this)"</span><span class="nt">&gt;</span>WFS Layer<span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">data-dialog=</span><span class="s">"new_vector"</span> <span class="na">onclick=</span><span class="s">"openDialog(this)"</span><span class="nt">&gt;</span>Vector Layer<span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">"new_wms"</span> <span class="na">style=</span><span class="s">"display:none;"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;p&gt;</span>New WMS layer<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;table&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">title=</span><span class="s">"URL of the WMS server."</span><span class="nt">&gt;</span>Server URL:<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">name=</span><span class="s">"server"</span> <span class="na">type=</span><span class="s">"text"</span><span class="nt">&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">value=</span><span class="s">"Check for layers"</span> <span class="na">onclick=</span><span class="s">"checkWmsLayer(this.form)"</span><span class="nt">&gt;&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">title=</span><span class="s">"Name of the layer on the WMS server."</span><span class="nt">&gt;</span>Layer name:<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">name=</span><span class="s">"layer"</span> <span class="na">type=</span><span class="s">"text"</span><span class="nt">&gt;&lt;select</span> <span class="na">name=</span><span class="s">"layerSel"</span> <span class="na">style=</span><span class="s">"display: none; max-width: 150px;"</span><span class="nt">&gt;&lt;/select&gt;&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">title=</span><span class="s">"Display name in OpenLayers."</span><span class="nt">&gt;</span>Display name:<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">name=</span><span class="s">"lyrname"</span> <span class="na">type=</span><span class="s">"text"</span><span class="nt">&gt;&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">title=</span><span class="s">"Layer transparency."</span><span class="nt">&gt;</span>Transparency:<span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">name=</span><span class="s">"transp"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="na">checked=</span><span class="s">"true"</span><span class="nt">&gt;&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;br/&gt;&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">value=</span><span class="s">"Create layer"</span> <span class="na">onclick=</span><span class="s">"addWmsLayer(this.form)"</span><span class="nt">&gt;&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre>
</div>

<p>The menu items are opened and closed with JavaScript events. When a member is clicked, the appropriate dialogue comes visible, which is stored in the <code class="highlighter-rouge">data-dialog</code> attribute. When a form gets submitted, a function gets the entire form, and processes the input parameters. These functions will be described later. For now, these are the events and functions managing the menu:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">openDialog</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">collapseMenu</span><span class="p">();</span>
    <span class="nx">closeDialog</span><span class="p">();</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">'data-dialog'</span><span class="p">)).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">'initial'</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">closeDialog</span><span class="p">()</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'new_wms'</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">'none'</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'new_wfs'</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">'none'</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'new_vector'</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">'none'</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'open_image'</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">'none'</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'open_vector'</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">'none'</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">collapseMenu</span><span class="p">()</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'menu_new_content'</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">'none'</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'menu_open_content'</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">'none'</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">expandMenu</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">evt</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">menuContent</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">menuContent</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">===</span> <span class="s1">'none'</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">menuContent</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">'block'</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">evt</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">evt</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">'none'</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">menuContent</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">'none'</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'menu_new'</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="nx">expandMenu</span><span class="p">);</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'menu_open'</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="nx">expandMenu</span><span class="p">);</span>

<span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="nx">collapseMenu</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</code></pre>
</div>

<p>In a nutshell, the <code class="highlighter-rouge">openDialog</code> function makes the representative form of the clicked menu item visible. It also calls the <code class="highlighter-rouge">closeDialog</code> function, which hides all of the forms, so only one form can be visible at a time. The <code class="highlighter-rouge">expandMenu</code> and <code class="highlighter-rouge">collapseMenu</code> functions are doing the same on the menu bar, although <code class="highlighter-rouge">expandMenu</code> uses a different, soft-coded method to hide the rest of the menus.</p>

<p>Note: there is also a notification and a coordinates bar under the map. The notification bar’s <code class="highlighter-rouge">id</code> is <code class="highlighter-rouge">notifications</code>. It will be called later, to provide feedback to the user.</p>

<h3 id="initial-modifications">Initial modifications</h3>

<p>In the first part of the series, we defined a toolbar for vector editing controls with the <code class="highlighter-rouge">EditingToolbar</code> control. We recreated this control for every editable vector layer separately. This method works just fine for 1-2 vector layers, however, the more editable layers are there, the more overhead there will be. To lower redundancy, in this part, there is only one toolbar, which is forced to change layer, once the target layer of the edit session is changed. For this, we have to change the <code class="highlighter-rouge">drawRegistry</code> function, and extend the <code class="highlighter-rouge">EditingToolbar</code> with a <code class="highlighter-rouge">setLayer</code> function.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">drawRegistry</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//Look for the displayInLayerSwitcher property, thus handler layers </span>
    <span class="c1">//won't appear in the layer tree.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">getOptions</span><span class="p">().</span><span class="nx">displayInLayerSwitcher</span> <span class="o">!=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//Create the HTML element of the layer</span>
        <span class="kd">var</span> <span class="nx">layerControl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"layerControl"</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">layerDiv</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'div'</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">layerP</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'p'</span><span class="p">);</span>
        <span class="nx">layerDiv</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="nx">layerDiv</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">'layerDiv'</span><span class="p">;</span>
        <span class="nx">layerP</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s1">' '</span><span class="p">;</span>
        <span class="nx">layerDiv</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">layerP</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">editCheck</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'input'</span><span class="p">);</span>
        <span class="nx">editCheck</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">'checkbox'</span><span class="p">;</span>
        <span class="nx">editCheck</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">'layerEdit_noselect'</span><span class="p">;</span>
        <span class="nx">editCheck</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">selectCheck</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'input'</span><span class="p">);</span>
        <span class="nx">selectCheck</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">'checkbox'</span><span class="p">;</span>
        <span class="nx">selectCheck</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">'layerDelete'</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">upButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'input'</span><span class="p">);</span>
        <span class="nx">upButton</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">'button'</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">downButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'input'</span><span class="p">);</span>
        <span class="nx">downButton</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">'button'</span><span class="p">;</span>
        <span class="c1">//If it is a vector layer, then editing should be available.</span>
        <span class="k">if</span> <span class="p">(</span><span class="sr">/Vector/g</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//Only one layer can be edited at a time, so block every other layer's edit option if one is </span>
            <span class="c1">//checked. Activate or deactivate the edit control correspondingly.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">featType</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">editCheck</span><span class="p">.</span><span class="nx">onchange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">checked</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">otherBoxes</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByName</span><span class="p">(</span><span class="s1">'layerEdit'</span><span class="p">);</span>
                        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">otherBoxes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">otherBoxes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="k">this</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">otherBoxes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                        <span class="kd">var</span> <span class="nx">editingToolbar</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">getControlsByClass</span><span class="p">(</span><span class="s1">'OpenLayers.Control.EditingToolbar'</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
                        <span class="nx">editingToolbar</span><span class="p">.</span><span class="nx">setLayer</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">);</span>
                        <span class="nx">editingToolbar</span><span class="p">.</span><span class="nx">activate</span><span class="p">();</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">allBoxes</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByName</span><span class="p">(</span><span class="s1">'layerEdit'</span><span class="p">);</span>
                        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">allBoxes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">allBoxes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="kd">var</span> <span class="nx">editingToolbar</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">getControlsByClass</span><span class="p">(</span><span class="s1">'OpenLayers.Control.EditingToolbar'</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
                        <span class="nx">editingToolbar</span><span class="p">.</span><span class="nx">deactivate</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">};</span>
                <span class="nx">editCheck</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">'layerEdit'</span><span class="p">;</span>
                <span class="nx">editCheck</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">upButton</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
            <span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">raiseLayer</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">};</span>
        <span class="nx">downButton</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
            <span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">raiseLayer</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">};</span>
        <span class="nx">layerDiv</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">editCheck</span><span class="p">);</span>
        <span class="nx">layerDiv</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">selectCheck</span><span class="p">);</span>
        <span class="nx">layerDiv</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">upButton</span><span class="p">);</span>
        <span class="nx">layerDiv</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">downButton</span><span class="p">);</span>
        <span class="c1">//Insert the new layer on the top of the stack, as it will be added on the top in OpenLayers.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">layerControl</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">layerControl</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">layerDiv</span><span class="p">,</span> <span class="nx">layerControl</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">layerControl</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">layerDiv</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">//Store the associated DOM element in the layer object. Be sure not to overwrite the original</span>
        <span class="c1">//layer.div property.</span>
        <span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">layerDiv</span> <span class="o">=</span> <span class="nx">layerDiv</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//Extend the EditingToolbar with a setLayer method which will sort out the corresponding draw control with</span>
<span class="c1">//the input layer's featType property, if it has one.</span>
<span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">EditingToolbar</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setLayer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">layer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">layer</span><span class="p">.</span><span class="nx">featType</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//Store the disabled controls in an object property, so iterating through the map's controls won't</span>
        <span class="c1">//be needed.</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">disabledControls</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">disabledControls</span> <span class="o">||</span> <span class="p">[];</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//Associate controls with a layer property with the input layer. Controls in the disabled array</span>
            <span class="c1">//won't be associated, therefore this has to be repeated prior to re-enabling the draw control.</span>
            <span class="c1">//Also check for handlers, which may have a layer property.</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">layer</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">layer</span> <span class="o">=</span> <span class="nx">layer</span><span class="p">;</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handler</span><span class="p">.</span><span class="nx">layer</span> <span class="o">=</span> <span class="nx">layer</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">try</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handlers</span><span class="p">.</span><span class="nx">feature</span><span class="p">.</span><span class="nx">layer</span> <span class="o">=</span> <span class="nx">layer</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">try</span><span class="p">{</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">layer</span> <span class="o">=</span> <span class="nx">layer</span><span class="p">;</span>
                        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">){}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="c1">//Disable the draw controls.</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">CLASS_NAME</span> <span class="o">===</span> <span class="s1">'OpenLayers.Control.DrawFeature'</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">disabledControls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
                <span class="nx">i</span><span class="o">--</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">switchType</span><span class="p">;</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nx">layer</span><span class="p">.</span><span class="nx">featType</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="s1">'POINT'</span> <span class="p">:</span>
                <span class="nx">switchType</span> <span class="o">=</span> <span class="s1">'olControlDrawFeaturePoint'</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">'LINE'</span> <span class="p">:</span>
                <span class="nx">switchType</span> <span class="o">=</span> <span class="s1">'olControlDrawFeaturePath'</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">'POLYGON'</span> <span class="p">:</span>
                <span class="nx">switchType</span> <span class="o">=</span> <span class="s1">'olControlDrawFeaturePolygon'</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="s1">'COLLECTION'</span> <span class="p">:</span>
                <span class="nx">switchType</span> <span class="o">=</span> <span class="s1">'olControlDrawFeature'</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">disabledControls</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//Enable only the corresponding control.</span>
            <span class="kd">var</span> <span class="nx">regular</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">switchType</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">regular</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">disabledControls</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">displayClass</span><span class="p">)</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">disabledControls</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">layer</span> <span class="o">=</span> <span class="nx">layer</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">disabledControls</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">disabledControls</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
                <span class="nx">i</span><span class="o">--</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">//Redraw the toolbar. Note that the redraw method is inherited from OpenLayers.Control.Panel.</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">redraw</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The modifications in the <code class="highlighter-rouge">drawRegistry</code> function are unequivocal. On activation, the function gets the only <code class="highlighter-rouge">EditingToolbar</code> control in the map, it calls its <code class="highlighter-rouge">setLayer</code> function when activated (with a layer object provided as an argument), then activates the control. On deactivation, it just simply deactivates the control.</p>

<p>The <code class="highlighter-rouge">setLayer</code> function is just a bit more complicated. As it is an extension for an existing control, we have to add the function to the control’s <code class="highlighter-rouge">prototype</code> object. The concept behind it, is that we disable every drawing controls on call, then only enable the appropriate ones. We also change the target layer for every enabled editing controls. The disabled controls are stored in an array, which is a property of the control. The <code class="highlighter-rouge">layer</code> property of the controls is in the <code class="highlighter-rouge">control.layer</code> property, however there can be a reference in <code class="highlighter-rouge">control.handler.layer</code>, <code class="highlighter-rouge">control.handlers.feature.layer</code>, or <code class="highlighter-rouge">control.targets[i].layer</code>, but only in one. This way the association can be wrapped in a series of try-catch clauses. To enable the corresponding controls, I used a regular expression based on the class name of the control. The regular expression is a search pattern, which can be used to test a string, if the expression’s content can be found in it.</p>

<h3 id="creating-the-controls">Creating the controls</h3>

<p>The map controls are consisting of three main groups of elements, the layer manipulation controls, the layer editing controls, and the layer independent controls. Most of the latter two are also panel controls, which are in the map view.</p>

<h4 id="layer-manipulation-controls">Layer manipulation controls</h4>

<p>Under layer manipulation, this part of the application means adding and removing layers. It can also fetch WMS capabilities from a CORS enabled server, just to show how to do that. There are dialogues for making connection to a WMS or WFS (only CORS enabled) server, adding an image overlay with an URL, or from your hard drive, and creating new or opening vector data. They have two common features: they require a form as an input, and they return an <code class="highlighter-rouge">OpenLayers.Layer</code> object as a result.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">//Add a WMS layer with user specified parameters.</span>
<span class="kd">function</span> <span class="nx">addWmsLayer</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">server</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">'http://'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">server</span> <span class="o">=</span> <span class="s1">'http://'</span> <span class="o">+</span> <span class="nx">server</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">layer</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">value</span> <span class="o">||</span> <span class="nx">form</span><span class="p">.</span><span class="nx">layerSel</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">lyrname</span><span class="p">.</span><span class="nx">value</span> <span class="o">||</span> <span class="s1">'WMS Layer'</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">transp</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">transp</span><span class="p">.</span><span class="nx">checked</span><span class="p">;</span>
    <span class="c1">//Check if the user has provided a server and a layer parameter. If yes, create the layer.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">server</span> <span class="o">!==</span> <span class="s1">''</span> <span class="o">&amp;&amp;</span> <span class="nx">layer</span> <span class="o">!==</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">wmsLayer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Layer</span><span class="p">.</span><span class="nx">WMS</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span>
        <span class="nx">server</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="na">layers</span><span class="p">:</span> <span class="nx">layer</span><span class="p">,</span>
            <span class="na">transparent</span><span class="p">:</span> <span class="nx">transp</span>
        <span class="p">});</span>
        <span class="nx">closeDialog</span><span class="p">();</span>
        <span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="nx">wmsLayer</span><span class="p">);</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'notifications'</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'WMS layer added to map.'</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">addWfsLayer</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">server</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">'http://'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">server</span> <span class="o">=</span> <span class="s1">'http://'</span> <span class="o">+</span> <span class="nx">server</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">ftype</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">lyrtype</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">ns</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">ns</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">lyrname</span><span class="p">.</span><span class="nx">value</span> <span class="o">||</span> <span class="s1">'WFS Layer'</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">server</span> <span class="o">!==</span> <span class="s1">''</span> <span class="o">&amp;&amp;</span> <span class="nx">ftype</span> <span class="o">!==</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">wfsLayer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Layer</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="p">{</span>
            <span class="na">strategies</span><span class="p">:</span> <span class="p">[</span><span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Strategy</span><span class="p">.</span><span class="nx">BBOX</span><span class="p">()],</span>
            <span class="na">protocol</span><span class="p">:</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Protocol</span><span class="p">.</span><span class="nx">WFS</span><span class="p">({</span>
                <span class="na">url</span><span class="p">:</span> <span class="nx">server</span><span class="p">,</span>
                <span class="na">featureType</span><span class="p">:</span> <span class="nx">ftype</span><span class="p">,</span>
                <span class="na">featureNS</span><span class="p">:</span> <span class="nx">ns</span>
            <span class="p">})</span>
        <span class="p">});</span>
        <span class="nx">closeDialog</span><span class="p">();</span>
        <span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="nx">wfsLayer</span><span class="p">);</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'notifications'</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'WFS layer added to map.'</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">addVectorLayer</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ftype</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">lyrtype</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">lyrname</span><span class="p">.</span><span class="nx">value</span> <span class="o">||</span> <span class="s1">'Vector Layer'</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">vectLayer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Layer</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">featType</span><span class="p">:</span> <span class="nx">ftype</span>
    <span class="p">});</span>
    <span class="nx">closeDialog</span><span class="p">();</span>
    <span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="nx">vectLayer</span><span class="p">);</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'notifications'</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'Vector layer added to map.'</span>
<span class="p">}</span>
</code></pre>
</div>

<p>In the first three functions, there are nothing new. We evaluate the user inputs, correct them, if they need to be corrected, then construct a <code class="highlighter-rouge">layer</code> object based on them.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">openImageFile</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">file</span> <span class="o">===</span> <span class="s1">'object'</span> <span class="o">&amp;&amp;</span> <span class="sr">/image/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">fr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
        <span class="nx">fr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">form</span><span class="p">.</span><span class="nx">dataURLval</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
            <span class="nx">form</span><span class="p">.</span><span class="nx">dataURL</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="nx">openImageLayer</span><span class="p">(</span><span class="nx">form</span><span class="p">);</span>
        <span class="p">};</span>
        <span class="nx">fr</span><span class="p">.</span><span class="nx">readAsDataURL</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">openImageLayer</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">dataURLval</span> <span class="o">||</span> <span class="nx">form</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">tempExtent</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">extent</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">','</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">extent</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">lyrname</span><span class="p">.</span><span class="nx">value</span> <span class="o">||</span> <span class="s1">'Image Layer'</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">testImage</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'img'</span><span class="p">);</span>
    <span class="nx">testImage</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">image</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">testImage</span><span class="p">.</span><span class="nx">height</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">testImage</span><span class="p">.</span><span class="nx">width</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">image</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">tempExtent</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">tempExtent</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">extent</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">tempExtent</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">transform</span> <span class="o">=</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Projection</span><span class="p">.</span><span class="nx">transform</span><span class="p">({</span><span class="na">x</span><span class="p">:</span> <span class="nx">testImage</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="na">y</span><span class="p">:</span> <span class="nx">testImage</span><span class="p">.</span><span class="nx">height</span><span class="p">},</span> <span class="s1">'EPSG:3857'</span><span class="p">,</span> <span class="nx">map</span><span class="p">.</span><span class="nx">projection</span><span class="p">)</span>
        <span class="nx">extent</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nx">transform</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">transform</span><span class="p">.</span><span class="nx">y</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">image</span> <span class="o">!==</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">imageLayer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Layer</span><span class="p">.</span><span class="nx">Image</span><span class="p">(</span>
            <span class="nx">name</span><span class="p">,</span>
            <span class="nx">image</span><span class="p">,</span>
            <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Bounds</span><span class="p">(</span><span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
            <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Size</span><span class="p">(</span><span class="nx">testImage</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">testImage</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
        <span class="p">);</span>
        <span class="nx">closeDialog</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">form</span><span class="p">.</span><span class="nx">dataURL</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">form</span><span class="p">.</span><span class="nx">dataURLval</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
            <span class="nx">form</span><span class="p">.</span><span class="nx">dataURL</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="nx">imageLayer</span><span class="p">);</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'notifications'</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'Image layer added to map.'</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">openVectorLayer</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">lyrname</span><span class="p">.</span><span class="nx">value</span> <span class="o">||</span> <span class="s1">'Vector Layer'</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">proj</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">proj</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">format</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">lyrtype</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">file</span> <span class="o">===</span> <span class="s1">'object'</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">fr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
        <span class="nx">fr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
            <span class="k">switch</span><span class="p">(</span><span class="nx">format</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="s1">'geojson'</span><span class="err">:</span>
                    <span class="kd">var</span> <span class="nx">ol_format</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Format</span><span class="p">.</span><span class="nx">GeoJSON</span><span class="p">({</span>
                        <span class="na">ignoreExtraDims</span><span class="p">:</span> <span class="kc">true</span>
                    <span class="p">});</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s1">'kml'</span><span class="err">:</span>
                    <span class="kd">var</span> <span class="nx">ol_format</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Format</span><span class="p">.</span><span class="nx">KML</span><span class="p">();</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s1">'osm'</span><span class="err">:</span>
                    <span class="kd">var</span> <span class="nx">ol_format</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Format</span><span class="p">.</span><span class="nx">OSM</span><span class="p">();</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s1">'wkt'</span><span class="err">:</span>
                    <span class="kd">var</span> <span class="nx">ol_format</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Format</span><span class="p">.</span><span class="nx">WKT</span><span class="p">();</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="kd">var</span> <span class="nx">vectLayer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Layer</span><span class="p">.</span><span class="nx">Vector</span><span class="p">();</span>
            <span class="nx">vectLayer</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
            <span class="nx">vectLayer</span><span class="p">.</span><span class="nx">projection</span> <span class="o">=</span> <span class="nx">proj</span><span class="p">;</span>
            <span class="nx">vectLayer</span><span class="p">.</span><span class="nx">featType</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
            <span class="nx">vectLayer</span><span class="p">.</span><span class="nx">addFeatures</span><span class="p">(</span><span class="nx">ol_format</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">text</span><span class="p">));</span>
            <span class="nx">closeDialog</span><span class="p">();</span>
            <span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="nx">vectLayer</span><span class="p">);</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'notifications'</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'Vector layer added to map.'</span>
        <span class="p">};</span>
        <span class="nx">fr</span><span class="p">.</span><span class="nx">readAsText</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now things start to get interesting. To open files from one’s hard drive, we can use the FileReader API, which can process a file to various formats in an asynchronous manner. In these cases we use text format for vector data, and data URL format for images, as they need to be provided as an URI. As the <code class="highlighter-rouge">FileReader</code> needs some time to read the provided data, we have to use its asynchronicity to load the data into the application, when it has been fetched. To do so, we assign a function to its <code class="highlighter-rouge">onload</code> event and place the rest of the code there.</p>

<p>As images can be also loaded from an URL, we place the reading process in another function, which will add the data URL to the input form, and call the layer constructor when finished. Images can be georeferenced manually, but it isn’t required. By default, the application checks for the <code class="highlighter-rouge">width</code> and <code class="highlighter-rouge">height</code> properties of the image, handles it as if it was in Web Mercator projection (to avoid exceeding the projection’s extent), then projects it to the current map projection.</p>

<p>Vector data can come in a variety of formats. Currently there aren’t any binary format handlers integrated in web mapping libraries, so we can only use ASCII formats. Every <code class="highlighter-rouge">OpenLayers.Format</code> object is a parser, which can decode data of its type and convert it into the application’s native vector structure. You can support any vector format which have a parser object. For this example, I chose to support some of the more popular formats: GeoJSON, WKT, OSM, and KML. Note that GeoJSON specification supports Z coordinates, which can be misinterpreted by the parser. To avoid this, it is recommended to set the <code class="highlighter-rouge">ignoreExtraDims</code> parameter to true.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">//Check for layers with a GetCapabilities request. Note that for this task, the server must be same origin,</span>
<span class="c1">//it has to be CORS-enabled, or you must use a proxy script.</span>
<span class="kd">function</span> <span class="nx">checkWmsLayer</span><span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="c1">//If the server URL doesn't start with http://, prepend to it. </span>
    <span class="k">if</span> <span class="p">(</span><span class="sr">/^</span><span class="se">((</span><span class="sr">http</span><span class="se">)</span><span class="sr">|</span><span class="se">(</span><span class="sr">https</span><span class="se">))(</span><span class="sr">:</span><span class="se">\/\/)</span><span class="sr">/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">server</span> <span class="o">=</span> <span class="s1">'http://'</span> <span class="o">+</span> <span class="nx">server</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//Create an async request to get and parse the response from the GetCapabilities request.</span>
    <span class="kd">var</span> <span class="nx">ajax</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
    <span class="nx">ajax</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ajax</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">ajax</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//Parse the response with the OpenLayers WMSCapabilities parser.</span>
            <span class="kd">var</span> <span class="nx">capabilities</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Format</span><span class="p">.</span><span class="nx">WMSCapabilities</span><span class="p">();</span>
            <span class="kd">var</span> <span class="nx">layersObj</span> <span class="o">=</span> <span class="nx">capabilities</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">ajax</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
            <span class="c1">//If the response is valid, create an option with every layer in a select tag.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">layersObj</span><span class="p">.</span><span class="nx">capability</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">layerSelect</span> <span class="o">=</span> <span class="nx">form</span><span class="p">.</span><span class="nx">layerSel</span><span class="p">;</span>
                <span class="nx">a</span> <span class="o">=</span> <span class="nx">layersObj</span><span class="p">;</span>
                <span class="k">while</span> <span class="p">(</span><span class="nx">layerSelect</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">layerSelect</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">layerSelect</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">layersObj</span><span class="p">.</span><span class="nx">capability</span><span class="p">.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">//Only include layers which projection are matching the map projection.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">layersObj</span><span class="p">.</span><span class="nx">capability</span><span class="p">.</span><span class="nx">layers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">bbox</span><span class="p">[</span><span class="nx">map</span><span class="p">.</span><span class="nx">getProjection</span><span class="p">()]</span> <span class="o">!==</span> <span class="s1">'undefined'</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">layerSelectElem</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'option'</span><span class="p">);</span>
                        <span class="nx">layerSelectElem</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">layersObj</span><span class="p">.</span><span class="nx">capability</span><span class="p">.</span><span class="nx">layers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">name</span><span class="p">;</span>
                        <span class="nx">layerSelectElem</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">layersObj</span><span class="p">.</span><span class="nx">capability</span><span class="p">.</span><span class="nx">layers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">name</span><span class="p">;</span>
                        <span class="nx">layerSelect</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">layerSelectElem</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="nx">form</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
                <span class="nx">form</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">'none'</span><span class="p">;</span>
                <span class="nx">layerSelect</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">'initial'</span><span class="p">;</span>
                <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'notifications'</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'Capabilities read successfully.'</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">form</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">'initial'</span><span class="p">;</span>
                <span class="nx">form</span><span class="p">.</span><span class="nx">layerSel</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">'none'</span><span class="p">;</span>
                <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'notifications'</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'Capability error.'</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">form</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">'initial'</span><span class="p">;</span>
            <span class="nx">form</span><span class="p">.</span><span class="nx">layerSel</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">'none'</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">ajax</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="nx">server</span> <span class="o">+</span> <span class="s1">'?REQUEST=GetCapabilities&amp;SERVICE=WMS'</span><span class="p">);</span>
    <span class="nx">ajax</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The twist in getting the capabilities from a server is the <code class="highlighter-rouge">XMLHttpRequest</code>. It can be used to make asynchronous requests to the server (AJAX). To make a <code class="highlighter-rouge">GetCapabilities</code> request, we only need to append the request parameters to the server URL, send the request, and bind a function to its <code class="highlighter-rouge">onreadystatechange</code> event. If the request returns with a status of 200, and a state of 4, it didn’t run into a CORS error, so we can check the result. If it can be parsed with <code class="highlighter-rouge">OpenLayers.Format.WMSCapabilities</code>, the server responded with an XML which can contain the result of the request, or an error. If we have a valid result, we get the layers, which are available in the map projection (from the <code class="highlighter-rouge">bbox</code> property). This method can also be used to get the layer extent from the WMS layer.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">deleteLayers</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">layers</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">layers</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">counter</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">layers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">layers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">layerDiv</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">layers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">layerDiv</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">checked</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">map</span><span class="p">.</span><span class="nx">removeLayer</span><span class="p">(</span><span class="nx">layers</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
                <span class="nx">counter</span><span class="o">++</span><span class="p">;</span>
                <span class="nx">i</span><span class="o">--</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span> 
    <span class="k">if</span> <span class="p">(</span><span class="nx">counter</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'notifications'</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'No layers selected to remove.'</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'notifications'</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">counter</span> <span class="o">+</span> <span class="s1">' layers removed from map.'</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The layer removing function is also quite simple, we just iterate through the layers and check if it is selected for removing. The checkbox is in a fixed position, so we can use its index number.</p>

<h4 id="layer-editing-controls">Layer editing controls</h4>

<p>The layer editing controls are used for feature manipulation, and they belong to the editing toolbar. Only one of the new controls needs to be defined, the delete feature.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">//Adapted from http://dev.openlayers.org/examples/wfs-protocol-transactions.js</span>
<span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">DeleteFeature</span> <span class="o">=</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Class</span><span class="p">(</span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">initialize</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">layer</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">[</span><span class="nx">options</span><span class="p">]);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">layer</span> <span class="o">=</span> <span class="nx">layer</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Handler</span><span class="p">.</span><span class="nx">Feature</span><span class="p">(</span>
            <span class="k">this</span><span class="p">,</span> <span class="nx">layer</span><span class="p">,</span> <span class="p">{</span><span class="na">click</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">clickFeature</span><span class="p">}</span>
        <span class="p">);</span>
    <span class="p">},</span>
    <span class="na">clickFeature</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">feature</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// if feature doesn't have a fid, destroy it</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">feature</span><span class="p">.</span><span class="nx">fid</span> <span class="o">==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">destroyFeatures</span><span class="p">([</span><span class="nx">feature</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">feature</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">State</span><span class="p">.</span><span class="nx">DELETE</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">triggerEvent</span><span class="p">(</span><span class="s2">"afterfeaturemodified"</span><span class="p">,</span> 
                                           <span class="p">{</span><span class="na">feature</span><span class="p">:</span> <span class="nx">feature</span><span class="p">});</span>
            <span class="nx">feature</span><span class="p">.</span><span class="nx">renderIntent</span> <span class="o">=</span> <span class="s2">"select"</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">drawFeature</span><span class="p">(</span><span class="nx">feature</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="na">setMap</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">handler</span><span class="p">.</span><span class="nx">setMap</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span>
        <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setMap</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">CLASS_NAME</span><span class="p">:</span> <span class="s2">"OpenLayers.Control.DeleteFeature"</span>
<span class="p">});</span>
</code></pre>
</div>

<p>This is a simple control with a handler, which allows us to select the feature which has to be deleted. It simply modifies the selected feature’s state to <code class="highlighter-rouge">DELETE</code>, then calls the <code class="highlighter-rouge">afterfeaturemodified</code> event, which updates the features based on their status.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">editingToolbar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">EditingToolbar</span><span class="p">(</span><span class="nx">vect</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">autoActivate</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">citeCompliant</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">allowDepress</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">createControlMarkup</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">control</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ctrlDiv</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'div'</span><span class="p">);</span>
        <span class="nx">ctrlDiv</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">control</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="nx">control</span><span class="p">.</span><span class="nx">div</span> <span class="o">=</span> <span class="nx">ctrlDiv</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">ctrlDiv</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span>
<span class="c1">//Remove the navigation tool from the editing toolbar, as it is completely useless.</span>
<span class="nx">editingToolbar</span><span class="p">.</span><span class="nx">controls</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="c1">//Add tooltips for the drawing controls, which are in fixed positions yet.</span>
<span class="nx">editingToolbar</span><span class="p">.</span><span class="nx">controls</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">div</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s1">'Draw point'</span><span class="p">;</span>
<span class="nx">editingToolbar</span><span class="p">.</span><span class="nx">controls</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">div</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s1">'Draw line'</span><span class="p">;</span>
<span class="nx">editingToolbar</span><span class="p">.</span><span class="nx">controls</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">div</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="s1">'Draw polygon'</span><span class="p">;</span>
<span class="c1">//Extend the toolbar with custom editing controls.</span>
<span class="nx">editingToolbar</span><span class="p">.</span><span class="nx">addControls</span><span class="p">([</span>
    <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">DragFeature</span><span class="p">(</span><span class="nx">vect</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">title</span><span class="p">:</span> <span class="s1">'Drag features'</span>
    <span class="p">}),</span>
    <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">DeleteFeature</span><span class="p">(</span><span class="nx">vect</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">title</span><span class="p">:</span> <span class="s1">'Delete features'</span>
    <span class="p">}),</span>
    <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">ModifyFeature</span><span class="p">(</span><span class="nx">vect</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">title</span><span class="p">:</span> <span class="s1">'Modify features'</span>
    <span class="p">}),</span>
    <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">Snapping</span><span class="p">({</span>
        <span class="na">layer</span><span class="p">:</span> <span class="nx">vect</span><span class="p">,</span>
        <span class="na">title</span><span class="p">:</span> <span class="s1">'Snap features'</span><span class="p">,</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">TYPE_TOGGLE</span>
    <span class="p">})</span>
<span class="p">]);</span>
</code></pre>
</div>

<p>The editing toolbar itself needs some tweaks to behave properly. The <code class="highlighter-rouge">allowDepress</code> property makes its containing controls able to be deactivated. This way there is no need to include the navigation control in the toolbar, as it is a duplicate of the map’s default navigation control. The <code class="highlighter-rouge">createControlMarkup</code> property is a function, which expected to return a DOM element to contain the control’s toggle button. We don’t really have to overwrite this function, but this way, as our own div element is bound to the control, we can add a tooltip to the default tools. This won’t change our application’s functionality, but definitely make it nicer.</p>

<p>The last step is to add the controls to the toolbar. The only unusual method is for the snapping tool, which needs the layer object as a KVP property. It also has a <code class="highlighter-rouge">type</code> property, as it needs to be activated with other editing controls. The <code class="highlighter-rouge">TYPE_TOGGLE</code> makes a control independent from other members of the toolbar, which are <code class="highlighter-rouge">TYPE_TOOL</code>s by default.</p>

<h4 id="layer-independent-controls">Layer independent controls</h4>

<p>These controls are the real map controls, as they are fully independent from the loaded and active layers. In this example, there are two new controls in the panel (which can be toggled), and one added directly to the map.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">notifyMeasure</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'notifications'</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'Measure: '</span> <span class="o">+</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">measure</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s1">' '</span> <span class="o">+</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">units</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">panel</span><span class="p">.</span><span class="nx">addControls</span><span class="p">([</span>
    <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">ZoomToMaxExtent</span><span class="p">({</span>
        <span class="na">title</span><span class="p">:</span> <span class="s1">'Zoom to maximum extent'</span>
    <span class="p">}),</span>
    <span class="nx">nav</span><span class="p">.</span><span class="nx">previous</span><span class="p">,</span>
    <span class="nx">nav</span><span class="p">.</span><span class="nx">next</span><span class="p">,</span>
    <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">Measure</span><span class="p">(</span>
        <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Handler</span><span class="p">.</span><span class="nx">Path</span><span class="p">,</span> <span class="p">{</span>
            <span class="na">eventListeners</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">measure</span><span class="p">:</span> <span class="nx">notifyMeasure</span><span class="p">,</span>
                <span class="na">measurepartial</span><span class="p">:</span> <span class="nx">notifyMeasure</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="na">immediate</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="na">title</span><span class="p">:</span> <span class="s1">'Measure line'</span>
        <span class="p">}</span>
    <span class="p">),</span>
    <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">Graticule</span><span class="p">({</span>
        <span class="na">title</span><span class="p">:</span> <span class="s1">'Show graticule'</span><span class="p">,</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">TYPE_TOGGLE</span>
    <span class="p">})</span>
<span class="p">]);</span>
</code></pre>
</div>

<p>The measure control needs a handler to draw measurable shapes. It can be a path or an area handler. It also needs some functions to notify about the results. In our case, the outcome can be seen in the notifications bar with a 5 digit precision. The <code class="highlighter-rouge">immediate</code> property makes sure the result updates with the movement of the pointer. The graticule control is a simple grid as a toggle type.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">map</span><span class="p">.</span><span class="nx">addControls</span><span class="p">([</span>
    <span class="nx">nav</span><span class="p">,</span>
    <span class="nx">panel</span><span class="p">,</span>
    <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">MousePosition</span><span class="p">({</span>
        <span class="na">div</span><span class="p">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'coordinates'</span><span class="p">)</span>
    <span class="p">}),</span>
    <span class="nx">editingToolbar</span><span class="p">,</span>
    <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">ScaleLine</span><span class="p">({</span>
        <span class="na">geodesic</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">topOutUnits</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">units</span><span class="p">,</span>
        <span class="na">topInUnits</span><span class="p">:</span> <span class="s1">'m'</span><span class="p">,</span>
        <span class="na">bottomOutUnits</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
        <span class="na">bottomInUnits</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
        <span class="na">fixWidth</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">eTop</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">maxWidth</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">eTop</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="o">+</span><span class="nb">parseFloat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">eTop</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="s1">' '</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">topOutUnits</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">eTop</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">eTop</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'px'</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">fixWidth</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="na">maxWidth</span><span class="p">:</span> <span class="mi">150</span>
    <span class="p">})</span>
<span class="p">]);</span>

<span class="nx">map</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">'moveend'</span><span class="p">,</span> <span class="nx">map</span><span class="p">.</span><span class="nx">getControlsByClass</span><span class="p">(</span><span class="s1">'OpenLayers.Control.ScaleLine'</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">map</span><span class="p">.</span><span class="nx">getControlsByClass</span><span class="p">(</span><span class="s1">'OpenLayers.Control.ScaleLine'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">fixWidth</span><span class="p">);</span>
</code></pre>
</div>

<p>The last control is a customized scale bar. By default, it has two scales with four different units. In this case, one scale is enough, so we leave the <code class="highlighter-rouge">bottomOutUnits</code> and <code class="highlighter-rouge">bottomInUnits</code> properties empty. With the <code class="highlighter-rouge">topOutUnits</code> set to map units, it will show the scale in degrees, when zoomed out. When the map is zoomed in so far, that degrees don’t really make sense, the application will change to meters, as defined in the <code class="highlighter-rouge">topInUnits</code> property.</p>

<p>When the scale bar is used with degrees, it has an ugly bug. Below 1 degree, it can only display the tenth of the previous scale, so the scale bar can be longer than defined in the <code class="highlighter-rouge">maxWidth</code> property, even longer than the map. To fix this, we use an ugly fix, which checks if the control surpassed its maximum width, and if that is the case, it halves the scale bar along with its numeric content. This is also a recursive function, as it may need multiple calls to truncate the scale bar into the right size. As a last step, we register this function to the map’s <code class="highlighter-rouge">moveend</code> event, so it is properly called after every redraw of the control.</p>

<div>
<div class="menuToggle" id="menu_new">
&nbsp;New
<div class="menuContent" id="menu_new_content" style="display: none;">
<div data-dialog="new_wms" onclick="openDialog(this)">
WMS Layer</div>
<div data-dialog="new_wfs" onclick="openDialog(this)">
WFS Layer</div>
<div data-dialog="new_vector" onclick="openDialog(this)">
Vector Layer</div>
</div>
</div>
<div class="menuToggle" id="menu_open">
&nbsp;Open
<div class="menuContent" id="menu_open_content" style="display: none;">
<div data-dialog="open_image" onclick="openDialog(this)">
Image Layer</div>
<div data-dialog="open_vector" onclick="openDialog(this)">
Vector Layer</div>
</div>
</div>
</div>
<div class="menuToggle" id="delete" onclick="deleteLayers()">
&nbsp;Delete</div>
<table style="height: 500px; table-layout: fixed; width: 720px;">
<tbody style="vertical-align: top;">
<tr>
        <td style="width: 200px;"><div id="layerControl_wrap" style="max-height: 500px; overflow: auto; width: 220px;">
Layers:<br />
<p>Name</p>
<img src="/assets/js/OpenLayers/theme/default/img/draw_point_on.png" style="height: 20px; width: 20px;" title="Edit layer" />
                <img src="/assets/js/OpenLayers/theme/default/img/overview_replacement.gif" style="height: 20px; width: 20px;" title="Select layer" />
<div style="border: 1px solid black; display: inline-block; height: 20px; position: relative; text-align: center; top: -4px; width: 20px;" title="Raise layer">
⇧</div>
<div style="border: 1px solid black; display: inline-block; height: 20px; position: relative; text-align: center; top: -4px; width: 20px;" title="Lower layer">
⇩</div>
<div id="layerControl">
</div>
</div>
</td>
        <td style="width: 500px;"><div id="map" style="height: 500px; width: 500px;">
</div>
</td>
    </tr>
</tbody>
</table>
<table style="table-layout: fixed; width: 720px;">
    <tbody>
<tr style="height: 20px;">
        <td style="width: 200px;"></td>
        <td style="width: 300px;"><span id="notifications"></span>
        </td>
        <td style="text-align: right; width: 200px;"><span id="coordinates"></span>
        </td>
    </tr>
</tbody></table>
<div id="dialog_wrap">
<form id="new_wms" style="display: none;">
New WMS layer<br />
<table>
            <tbody>
<tr>
                <td title="URL of the WMS server.">Server URL:</td>
                <td><input name="server" type="text" /></td>
                <td><input onclick="checkWmsLayer(this.form)" type="button" value="Check for layers" /></td>
            </tr>
<tr>
                <td title="Name of the layer on the WMS server.">Layer name:</td>
                <td><input name="layer" type="text" /><select name="layerSel" style="display: none; max-width: 150px;"></select></td>
            </tr>
<tr>
                <td title="Display name in OpenLayers.">Display name:</td>
                <td><input name="lyrname" type="text" /></td>
            </tr>
<tr>
                <td title="Layer transparency.">Transparency:</td>
                <td><input checked="true" name="transp" type="checkbox" /></td>
            </tr>
<tr>
                <td><br /></td>
            </tr>
<tr>
                <td><input onclick="addWmsLayer(this.form)" type="button" value="Create layer" /></td>
            </tr>
</tbody></table>
</form>
<form id="new_wfs" style="display: none;">
New WFS layer<br />
<table>
            <tbody>
<tr>
                <td title="URL of the WFS server.">Server URL:</td>
                <td><input name="server" type="text" /></td>
            </tr>
<tr>
                <td title="Name of the &quot;layer&quot; on the WFS server.">Layer:</td>
                <td><input name="lyrtype" type="text" /></td>
            </tr>
<tr>
                <td title="Namespace of the feature type.">Namespace (optional):</td>
                <td><input name="ns" type="text" /></td>
            </tr>
<tr>
                <td title="Display name in OpenLayers.">Display name:</td>
                <td><input name="lyrname" type="text" /></td>
            </tr>
<tr>
                <td><br /></td>
            </tr>
<tr>
                <td><input onclick="addWfsLayer(this.form)" type="button" value="Create layer" /></td>
            </tr>
</tbody></table>
</form>
<form id="new_vector" style="display: none;">
New Vector layer<br />
<table>
            <tbody>
<tr>
                <td title="Type of the vector layer.">Feature type:</td>
                <td><select name="lyrtype">
                        <option value="POINT">Point</option>
                        <option value="LINE">Line</option>
                        <option value="POLYGON">Polygon</option>
                        <option value="COLLECTION">Geometry collection</option>
                    </select>
                </td>
            </tr>
<tr>
                <td title="Display name in OpenLayers.">Display name:</td>
                <td><input name="lyrname" type="text" /></td>
            </tr>
<tr>
                <td><br /></td>
            </tr>
<tr>
                <td><input onclick="addVectorLayer(this.form)" type="button" value="Create layer" /></td>
            </tr>
</tbody></table>
</form>
<form id="open_image" style="display: none;">
Open Image layer<br />
<table>
            <tbody>
<tr>
                <td>Image from URL</td>
            </tr>
<tr>
                <td title="URL of the image.">Image URL:</td>
                <td><input name="url" type="text" /></td>
            </tr>
<tr>
                <td>Image from file</td>
            </tr>
<tr>
                <td title="Path of the image.">Image path:</td>
                <td><input accept="image/*" name="file" type="file" /></td>
            </tr>
<tr>
                <td title="Boundary coordinates of the image. Leave blank for non-georeferenced image.">Image extent (W,S,E,N):</td>
                <td><input name="extent" type="text" /></td>
            </tr>
<tr>
                <td title="Display name in OpenLayers.">Display name:</td>
                <td><input name="lyrname" type="text" /></td>
            </tr>
<tr>
                <td><br /></td>
            </tr>
<tr>
                <td><input onclick="openImageLayer(this.form)" type="button" value="Create layer (URL)" /></td>
                <td><input onclick="openImageFile(this.form)" type="button" value="Create layer (file)" /></td>
            </tr>
</tbody></table>
</form>
<form id="open_vector" style="display: none;">
Open Vector layer<br />
<table>
            <tbody>
<tr>
                <td title="Projection of the vector layer.">Projection:</td>
                <td><select name="proj">
                        <option value="EPSG:4326">EPSG:4326</option>
                        <option value="EPSG:3857">EPSG:3857</option>
                    </select>
                </td>
            </tr>
<tr>
                <td title="Format of the vector layer.">Format:</td>
                <td><select name="format">
                        <option value="geojson">GeoJSON</option>
                        <option value="kml">KML</option>
                        <option value="osm">OSM</option>
                        <option value="wkt">WKT</option>
                    </select>
                </td>
            </tr>
<tr>
                <td title="Type of the vector layer.">Feature type:</td>
                <td><select name="lyrtype">
                        <option value="POINT">Point</option>
                        <option value="LINE">Line</option>
                        <option value="POLYGON">Polygon</option>
                        <option value="COLLECTION">Geometry collection</option>
                    </select>
                </td>
            </tr>
<tr>
                <td title="Path of the vetor.">Vector path:</td>
                <td><input name="file" type="file" /></td>
            </tr>
<tr>
                <td title="Display name in OpenLayers.">Display name:</td>
                <td><input name="lyrname" type="text" /></td>
            </tr>
<tr>
                <td><br /></td>
            </tr>
<tr>
                <td><input onclick="openVectorLayer(this.form)" type="button" value="Open layer" /></td>
            </tr>
</tbody></table>
</form>
</div>

<script src="/assets/js/OpenLayers/OpenLayers.js" type="text/javascript"></script>

<script src="/assets/js/openlayers-webgis-2.js" type="text/javascript"></script>


  </article>

  
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname  = 'gaborfarkas-github-io';
      var disqus_identifier = '/blog/2015/openlayers-webgis-2';
      var disqus_title      = "WebGIS application with OpenLayers 2 - Part 2: Map controls";
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  

</div>

      </div>
    </div>

    <footer>

  <div class="wrapper">
    &copy; Copyright 2017 Gábor Farkas.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>.

    
  </div>

</footer>


    <!-- Load jQuery -->
<script src="//code.jquery.com/jquery-1.12.4.min.js"></script>

<!-- Load Common JS -->
<script src="https://gaborfarkas.github.io/assets/js/common.js"></script>


<!-- Load KaTeX -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js"></script>
<script src="https://gaborfarkas.github.io/assets/js/katex.js"></script>




<!-- Include custom icon fonts -->
<link rel="stylesheet" href="https://gaborfarkas.github.io/assets/css/font-awesome.min.css">
<link rel="stylesheet" href="https://gaborfarkas.github.io/assets/css/academicons.min.css">

<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-107151753-1', 'auto');
  ga('send', 'pageview');

</script>


  </body>

</html>

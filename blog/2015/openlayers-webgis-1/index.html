<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Gábor Farkas | WebGIS application with OpenLayers 2 - Part 1: Layer tree</title>
  <meta name="description" content="My personal site.">

  <link rel="shortcut icon" href="https://gaborfarkas.github.io/assets/img/favicon.ico">

  <link rel="stylesheet" href="https://gaborfarkas.github.io/assets/css/main.css">
  <link rel="canonical" href="https://gaborfarkas.github.io/blog/2015/openlayers-webgis-1/">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    
    <span class="site-title">
        
        Gábor Farkas
    </span>
    

    <nav class="site-nav">

      <div class="trigger">
        <!-- About -->
        <a class="page-link" href="https://gaborfarkas.github.io/">about</a>

        <!-- Blog -->
        <a class="page-link" href="https://gaborfarkas.github.io/blog/">blog</a>

        <!-- Pages -->
        
          
        
          
            <a class="page-link" href="https://gaborfarkas.github.io/cv/">CV</a>
          
        
          
        
          
        
          
            <a class="page-link" href="https://gaborfarkas.github.io/publications/">publications</a>
          
        
          
            <a class="page-link" href="https://gaborfarkas.github.io/stuff/">stuff</a>
          
        
          
        
          
        
          
        

      </div>
    </nav>

  </div>

</header>



    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">WebGIS application with OpenLayers 2 - Part 1: Layer tree</h1>
    <p class="post-meta">January 25, 2015</p>
  </header>

  <article class="post-content">
    <style>
tbody {
    vertical-align: top;
}
#layerControl_wrap img {
    padding: 0px;
}
#layerControl_wrap {
    width: 200px;
    max-height: 500px;
    overflow: auto;
    padding: 0px;
}
#layerControl_wrap p {
    width: 100px;
    word-break: break-all;
    display: inline-table;
}
#layerControl_wrap input {
    width: 20px;
    height: 20px;
    margin: 0px 0px 0px 4px;
}
#layerControl_wrap input[type=button] {
    position: relative;
    bottom: 3px;
}
.olControlPanel .olButton {
    top: 5px;
    position: relative;
    left: 100px;
    background-repeat: no-repeat;
    background-color: #EBEBE6;
    margin: 0 0 5px 5px;
    width: 24px;
    height: 22px;
    cursor: pointer;
    float: left;
    border-radius: 5px 5px 5px 5px;
    border: 1px grey solid;
}
.olControlPanel .olControlZoomToMaxExtentItemInactive { 
    background-image: url("http://openlayers.org/api/img/zoom-world-mini.png");
    background-size: contain;
}
.olControlPanel .olControlNavigationHistory {
    background-image: url("http://openlayers.org/api/theme/default/img/navigation_history.png");
}
svg {
        max-height: initial;
    }
</style>

<p>Creating a whole WebGIS application is a time-consuming task, which can be eased with toolkits, like GeoExt or Heron MC. However, using such a toolkit, has some disadvantages. For example, you can’t keep step with the evolution of the mapping libraries, as the toolkits can’t develop so rapidly. If you want to use the most recent features, and don’t want to wait for the developers of your favourite toolkit to come up with a new version, you have to build your application just on the library.</p>

<p>From another point of view, learning how a web mapping library works can be rewarding. If you build your WebGIS application, you can easily come across a situation, where you have to customize it in a way, that hasn’t been implemented in your toolkit. At this point, you will need to learn how to use the native library anyway (and consider yourself lucky, if you don’t work with a deadline). To avoid such a case, it is considerable to get acquainted with the library in time and use toolkits later. In the next few posts, I will demonstrate how to build a basic WebGIS application with only HTML, JavaScript, and OpenLayers 2. I will try to summarize the content of the last few posts, and show how to handle browser events with the library.</p>

<p>The goal of this post is to show how to build a basic WebGIS application with layer management, and editing features. The application has the following features:</p>

<ul>
  <li>Layer handling, showing them in a layer tree.</li>
  <li>Basic layer management (changing layer order for now).</li>
  <li>Editing vector layers.</li>
  <li>Basic map controls (zooming to maximum extent, navigation history).</li>
</ul>

<h3 id="the-layer-tree">The layer tree</h3>

<p>The first task is to create the container of the map and the layer tree. The layer tree is a simple HTML div element, nothing fancy, like <a href="https://demo.geomoose.org/master/desktop/">GeoMOOSE</a>. To achieve this task, I created a table with two columns. The first one contains the layer tree, while the second one is for the map. The layer tree contains a wrapper div to store the metadata of the layer tree, like the title. In the wrapper, there is a <code class="highlighter-rouge">div</code>, called <code class="highlighter-rouge">layerControl</code>, which will be populated with the actual layers as divs. The code for this is the following:</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;table</span> <span class="na">style=</span><span class="s">"width:950px; height:500px;"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;td&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"layerControl_wrap"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;p&gt;</span>Layers:<span class="nt">&lt;/p&gt;</span>
                <span class="nt">&lt;br/&gt;</span>
                <span class="nt">&lt;p&gt;</span>Name<span class="nt">&lt;/p&gt;</span>
                <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"../../OpenLayers-2.13.1/theme/default/img/draw_point_on.png"</span> <span class="na">style=</span><span class="s">"width:20px; height: 20px;"</span> <span class="na">title=</span><span class="s">"Edit layer"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"../../OpenLayers-2.13.1/theme/default/img/overview_replacement.gif"</span> <span class="na">style=</span><span class="s">"width:20px; height: 20px;"</span> <span class="na">title=</span><span class="s">"Select layer"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"width: 20px; height:20px; border: 1px solid black; text-align: center; display: inline-block; position:relative; top: 2px;"</span> <span class="na">title=</span><span class="s">"Raise layer"</span><span class="nt">&gt;</span>⇧<span class="nt">&lt;/div&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"width: 20px; height:20px; border: 1px solid black; text-align: center; display: inline-block; position:relative; top: 2px;"</span> <span class="na">title=</span><span class="s">"Lower layer"</span><span class="nt">&gt;</span>⇩<span class="nt">&lt;/div&gt;</span>
                <span class="nt">&lt;br/&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"layerControl"</span><span class="nt">&gt;&lt;/div&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/td&gt;</span>
        <span class="nt">&lt;td&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"map"</span> <span class="na">style=</span><span class="s">"width:700px; height:500px;"</span><span class="nt">&gt;&lt;/div&gt;</span>
        <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</code></pre>
</div>

<p>The schema for the layer tree contains a title, called “Layers:”. Then it has the legend for every column, precisely “Name”, edit checkbox, select checkbox, raise layer button, and lower layer button. This layout resembles a table, but it is achieved with divs and CSS.</p>

<p>The next step, is to create a function which will populate the layer tree with the layers. The name of the function is <code class="highlighter-rouge">drawRegistry()</code>, and it will create a div for every layer when it is added. The function is associated with an event, so it gets an input parameter. This input parameter is an event object, which contains, inter alia, the layer object the function got called upon. This way, we can soft-code the function, and reuse in any environment.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">drawRegistry</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//Look for the displayInLayerSwitcher property, thus handler layers </span>
    <span class="c1">//won't appear in the layer tree.</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">getOptions</span><span class="p">().</span><span class="nx">displayInLayerSwitcher</span> <span class="o">!=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//Create the HTML element of the layer</span>
        <span class="kd">var</span> <span class="nx">layerControl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"layerControl"</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">layerDiv</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'div'</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">layerP</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'p'</span><span class="p">);</span>
        <span class="nx">layerDiv</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="nx">layerDiv</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">'layerDiv'</span><span class="p">;</span>
        <span class="nx">layerP</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s1">' '</span><span class="p">;</span>
        <span class="nx">layerDiv</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">layerP</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">editCheck</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'input'</span><span class="p">);</span>
        <span class="nx">editCheck</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">'checkbox'</span><span class="p">;</span>
        <span class="nx">editCheck</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">'layerEdit_noselect'</span><span class="p">;</span>
        <span class="nx">editCheck</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">selectCheck</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'input'</span><span class="p">);</span>
        <span class="nx">selectCheck</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">'checkbox'</span><span class="p">;</span>
        <span class="nx">selectCheck</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">'layerDelete'</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">upButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'input'</span><span class="p">);</span>
        <span class="nx">upButton</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">'button'</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">downButton</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'input'</span><span class="p">);</span>
        <span class="nx">downButton</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">'button'</span><span class="p">;</span>
        <span class="c1">//If it is a vector layer, then editing should be available.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'Vector'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//Create an edit toolbox for the layer, which has the ID of the layer as a property, so it</span>
            <span class="c1">//can be looked up later.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">getControlsBy</span><span class="p">(</span><span class="s1">'layerId'</span><span class="p">,</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">){</span>
                <span class="kd">var</span> <span class="nx">editControl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">EditingToolbar</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">,</span> <span class="p">{</span>
                    <span class="na">autoActivate</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> 
                    <span class="na">citeCompliant</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> 
                    <span class="na">layerId</span><span class="p">:</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">id</span> 
                <span class="p">});</span>
                <span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">addControl</span><span class="p">(</span><span class="nx">editControl</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">editControl</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">getControlsBy</span><span class="p">(</span><span class="s1">'layerId'</span><span class="p">,</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">id</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="c1">//Only one layer can be edited at a time, so block every other layer's edit option if one is </span>
            <span class="c1">//checked. Activate or deactivate the edit control correspondingly.</span>
            <span class="nx">editCheck</span><span class="p">.</span><span class="nx">onchange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">checked</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">editControl</span><span class="p">.</span><span class="nx">activate</span><span class="p">();</span>
                    <span class="kd">var</span> <span class="nx">otherBoxes</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByName</span><span class="p">(</span><span class="s1">'layerEdit'</span><span class="p">);</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">otherBoxes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">otherBoxes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="k">this</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">otherBoxes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">editControl</span><span class="p">.</span><span class="nx">deactivate</span><span class="p">();</span>
                    <span class="kd">var</span> <span class="nx">allBoxes</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByName</span><span class="p">(</span><span class="s1">'layerEdit'</span><span class="p">);</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">allBoxes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">allBoxes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                    <span class="p">}</span>
                    
                <span class="p">}</span>
            <span class="p">};</span>
            <span class="nx">editCheck</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">'layerEdit'</span><span class="p">;</span>
            <span class="nx">editCheck</span><span class="p">.</span><span class="nx">disabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">upButton</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
            <span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">raiseLayer</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">};</span>
        <span class="nx">downButton</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
            <span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">raiseLayer</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">};</span>
        <span class="nx">layerDiv</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">editCheck</span><span class="p">);</span>
        <span class="nx">layerDiv</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">selectCheck</span><span class="p">);</span>
        <span class="nx">layerDiv</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">upButton</span><span class="p">);</span>
        <span class="nx">layerDiv</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">downButton</span><span class="p">);</span>
        <span class="nx">layerControl</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">layerDiv</span><span class="p">);</span>
        <span class="c1">//Store the associated DOM element in the layer object. Be sure not to overwrite the original</span>
        <span class="c1">//layer.div property.</span>
        <span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">layerDiv</span> <span class="o">=</span> <span class="nx">layerDiv</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>In OpenLayers 2, when we draw on the map, a little blue point indicates the point of the cursor. This helping function has been implemented as a handler layer, and gets created every time an edit session has started. For this, the first thing our function has to check, is if a newly created layer is a handler layer or not. Luckily, there is a <code class="highlighter-rouge">displayInLayerSwitcher</code> boolean attribute for every layer, and the default value for a handler layer is false.</p>

<p>Next, we should separate the handling of the vector layers from any other layer type. Vector layers can be edited, so they need a checkable edit checkbox. They also need an editing control, for which there is a very handy control in OpenLayers 2, called <code class="highlighter-rouge">OpenLayers.Control.EditingToolbar</code>. It is a toolbar with basic controls for creating features, however it can be extended. For now, the plain control is enough. The toolbar is created only if there isn’t one already for the layer. This can be checked with the custom <code class="highlighter-rouge">layerId</code> property, which is assigned to the control on the construction. The control gets assigned to a variable, so it can be called later in the function.</p>

<p>Now that we have the edit control assigned to the layer, we have to take care of the initialization of the edit session. The edit checkbox is the input of the session, so we will create an event, which will listen for the change in the checkbox’s status. We can only edit one layer at a time, so if an edit session is started, we disable the checkbox for every other layer. Note that we call the <code class="highlighter-rouge">getElementsByName()</code> method to get the edit checkboxes of the other vector layers. This way the raster layers remain uneditable, as their DOM elements are created with the name <code class="highlighter-rouge">editLayer_noselect</code>. When an edit session ends, we disable the corresponding toolbar, so the handler layer gets removed properly. After then, we enable the checkboxes of the vector layers.</p>

<p>Finally, we assign the corresponding functions for the layer order change buttons. These functions are explained in a previous post, OpenLayers layer management. We save the newly created DOM element in the layer object. I created a <code class="highlighter-rouge">layerDiv</code> property, as there is a <code class="highlighter-rouge">div</code> property already, which causes the library to fail, if overwritten.</p>

<h3 id="the-map-object">The map object</h3>

<p>The map object is quite simple, there are only a few required options we have to set up. OpenLayers 2 can only work with only one projection, which will be initialized with the object construction. This way, we can assign a maximum extent based on the chosen projection, so the users won’t be able to digitize out of the projection’s bounds. Note that the default behaviour of the library will allow such actions, so we have to make restrictions. We can assign a maximum resolution, which can be used to fit the map to the canvas on zoom level 0. This is optional, however can assist the restriction. When the projection’s bounds fit in the canvas on a zoom level entirely, users will be able to digitize out of bounds despite of the maximum extent. The last options will be the <code class="highlighter-rouge">allOverlays</code> flag, which will make sure, that the map can be initialized without a WMS layer.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Map</span><span class="p">(</span><span class="s1">'map'</span><span class="p">,{</span>
    <span class="c1">//The map should have only overlays, so it won't look for global WMS specific properties, such as</span>
    <span class="c1">//wrapDateLine.</span>
    <span class="na">allOverlays</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">eventListeners</span><span class="p">:</span> <span class="p">{</span>
        <span class="c1">//After adding a layer, create a layer tree registry.</span>
        <span class="na">addlayer</span><span class="p">:</span> <span class="nx">drawRegistry</span><span class="p">,</span>
        <span class="c1">//The edit control should be removed prior to layer removal, so the correct event is the preremovelayer.</span>
        <span class="c1">//As the belonging control has the ID of the layer, it can be called with getControlsBy().</span>
        <span class="na">preremovelayer</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">getOptions</span><span class="p">().</span><span class="nx">displayInLayerSwitcher</span> <span class="o">!=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">layerControl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"layerControl"</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">layerTr</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
                <span class="nx">layerControl</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">layerTr</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'Vector'</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">rmcontrol</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">getControlsBy</span><span class="p">(</span><span class="s1">'layerId'</span><span class="p">,</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">id</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
                    <span class="nx">rmcontrol</span><span class="p">.</span><span class="nx">deactivate</span><span class="p">();</span>
                    <span class="c1">//Clean up the toolbar's subcontrols.</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="k">in</span> <span class="nx">rmcontrol</span><span class="p">.</span><span class="nx">controls</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">removeControl</span><span class="p">(</span><span class="nx">rmcontrol</span><span class="p">.</span><span class="nx">controls</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
                    <span class="p">}</span>
                    <span class="nx">evt</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">removeControl</span><span class="p">(</span><span class="nx">rmcontrol</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="c1">//When the layer order changes, fire an event to redraw the layer tree correctly.</span>
        <span class="na">changelayer</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">property</span> <span class="o">===</span> <span class="s1">'order'</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">layerControl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'layerControl'</span><span class="p">);</span>
                <span class="c1">//Clear out the entire layer tree.</span>
                <span class="k">while</span> <span class="p">(</span><span class="nx">layerControl</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">layerControl</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">layerControl</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="c1">//Redraw every layer. Note that in computing, the uppermost element is the last one, </span>
                <span class="c1">//while in GIS, the top layer is the first, so we have to work with reverse ordering.</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">j</span><span class="o">&lt;</span><span class="nx">evt</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">layerControl</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">layers</span><span class="p">[</span><span class="nx">evt</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="nx">j</span><span class="p">].</span><span class="nx">layerDiv</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="c1">//Restrict the extent, so digitizing out of the projection's bounds is impossible.</span>
    <span class="na">restrictedExtent</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">90</span><span class="p">],</span>
    <span class="na">maxResolution</span><span class="p">:</span> <span class="mf">0.35</span>
<span class="p">});</span>
</code></pre>
</div>

<p>The object only differs from the previous one in the <code class="highlighter-rouge">eventListeners</code> section. It is designed to define events connected to the map object on construction. We only add the most important events for our cause. When a layer is added, the <code class="highlighter-rouge">drawRegistry</code> function will be invoked with the layer object. Prior to layer deletion, the <code class="highlighter-rouge">preremovelayer</code> event will take care of the layer’s controls and layer tree element. Finally, when the order of the layer changes, the <code class="highlighter-rouge">changelayer</code> event will fire up, and redraw the entire registry. Note that, to clear out the layer tree easily, you need a wrapper div, which contains the layer tree elements.</p>

<h3 id="initializing-the-map">Initializing the map</h3>

<p>For putting the finishing touches to the application, we add a custom control panel and a default vector layer to the map. To successfully initialize the map object, a layer is needed. To achieve this, we make an empty layer object and add it to the map.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">//Create a new panel for the universal controls, like navigation history. Define the element type, which</span>
<span class="c1">//should contain the control. It can be anything as it will get an .olButton class, which will make it clickable.</span>
<span class="kd">var</span> <span class="nx">panel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">Panel</span><span class="p">({</span>
    <span class="na">createControlMarkup</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">control</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'div'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="c1">//Create a navigation history control. Note that the main control has to be added to the map object, while</span>
<span class="c1">//its two subcontrols can be added to the control panel.</span>
<span class="kd">var</span> <span class="nx">nav</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">NavigationHistory</span><span class="p">({</span>
<span class="p">});</span>

<span class="nx">panel</span><span class="p">.</span><span class="nx">addControls</span><span class="p">([</span>
    <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">ZoomToMaxExtent</span><span class="p">(),</span>
    <span class="nx">nav</span><span class="p">.</span><span class="nx">previous</span><span class="p">,</span>
    <span class="nx">nav</span><span class="p">.</span><span class="nx">next</span>
<span class="p">]);</span>

<span class="nx">map</span><span class="p">.</span><span class="nx">addControls</span><span class="p">([</span><span class="nx">nav</span><span class="p">,</span> <span class="nx">panel</span><span class="p">]);</span>
<span class="c1">//Create a layer to initialize the map.</span>
<span class="kd">var</span> <span class="nx">vect</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Layer</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="s1">'VectorLayer 1'</span><span class="p">,{</span>
    <span class="na">maxExtent</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">90</span><span class="p">],</span>
    <span class="na">projection</span><span class="p">:</span> <span class="s2">"EPSG:4326"</span>
<span class="p">});</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="nx">vect</span><span class="p">);</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">zoomToMaxExtent</span><span class="p">();</span>
</code></pre>
</div>

<p>The panel is a container for varying controls. We only define its <code class="highlighter-rouge">createControlMarkup</code> parameter, as it won’t know what kind of element it should make for the control buttons by default. We can style the buttons with CSS, as the class name of the controls are constant, and they will be children of the control panel element.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code>tbody {
    vertical-align: top;
}
#layerControl_wrap {
    width: 250px;
    max-height: 500px;
    overflow: auto;
}
#layerControl_wrap p {
    width: 100px;
    word-break: break-all;
    display: inline-table;
}
#layerControl_wrap input {
    width: 20px;
    height: 20px;
    margin-left: 4px;
}
#layerControl_wrap input[type=button] {
    position: relative;
    bottom: 3px;
}
.olControlPanel .olButton {
    top: 5px;
    position: relative;
    left: 100px;
    background-repeat: no-repeat;
    background-color: #EBEBE6;
    margin: 0 0 5px 5px;
    width: 24px;
    height: 22px;
    cursor: pointer;
    float: left;
    border-radius: 5px 5px 5px 5px;
    border: 1px grey solid;
}
.olControlPanel .olControlZoomToMaxExtentItemInactive { 
    background-image: url("../../OpenLayers-2.13.1/img/zoom-world-mini.png");
    background-size: contain;
}
.olControlPanel .olControlNavigationHistory {
    background-image: url("../../OpenLayers-2.13.1/theme/default/img/navigation_history.png");
}
</code></pre>
</div>

<p>Feel free to test the first part of the application. The <code class="highlighter-rouge">map</code> object is global, called map. You can add layers in the console with the <code class="highlighter-rouge">map.addLayer()</code> function, after you have created the layer object. Please be sure, that the layer is in a WGS 84 projection (EPSG:4326). A code snippet for adding further layers is the following:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">raster</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Layer</span><span class="p">.</span><span class="nx">WMS</span><span class="p">(</span>
    <span class="s1">'GlobImagery'</span><span class="p">,</span>
    <span class="s1">'http://demo.opengeo.org/geoserver/wms'</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="na">layers</span><span class="p">:</span> <span class="s1">'bluemarble'</span>
<span class="p">});</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="nx">raster</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">vector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Layer</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="s1">'Someothervectorlayer_withapointlesslylongname'</span><span class="p">,{</span>
    <span class="na">maxExtent</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">90</span><span class="p">],</span>
    <span class="na">projection</span><span class="p">:</span> <span class="s2">"EPSG:4326"</span>
<span class="p">});</span>
<span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="nx">vector</span><span class="p">);</span>
</code></pre>
</div>

<table style="height: 500px; table-layout: fixed; width: 720px;">
<tbody style="vertical-align: top;">
<tr>
        <td style="width: 200px;"><div id="layerControl_wrap" style="max-height: 500px; overflow: auto; width: 220px;">
Layers:<br />
<br />
<br />
<p>Name</p>
<img src="/assets/js/OpenLayers/theme/default/img/draw_point_on.png" style="height: 20px; width: 20px;" title="Edit layer" />
                <img src="/assets/js/OpenLayers/theme/default/img/overview_replacement.gif" style="height: 20px; width: 20px;" title="Select layer" />
<div style="border: 1px solid black; display: inline-block; height: 20px; position: relative; text-align: center; top: -4px; width: 20px;" title="Raise layer">
⇧</div>
<div style="border: 1px solid black; display: inline-block; height: 20px; position: relative; text-align: center; top: -4px; width: 20px;" title="Lower layer">
⇩</div>
<br />
<div id="layerControl">
</div>
</div>
</td>
        <td style="width: 500px;"><div id="map" style="height: 500px; width: 500px;">
</div>
</td>
    </tr>
</tbody>
</table>

<script src="/assets/js/OpenLayers/OpenLayers.js" type="text/javascript"></script>

<script src="/assets/js/openlayers-webgis-1.js" type="text/javascript"></script>


  </article>

  
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname  = 'gaborfarkas-github-io';
      var disqus_identifier = '/blog/2015/openlayers-webgis-1';
      var disqus_title      = "WebGIS application with OpenLayers 2 - Part 1: Layer tree";
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  

</div>

      </div>
    </div>

    <footer>

  <div class="wrapper">
    &copy; Copyright 2017 Gábor Farkas.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>.

    
  </div>

</footer>


    <!-- Load jQuery -->
<script src="//code.jquery.com/jquery-1.12.4.min.js"></script>

<!-- Load Common JS -->
<script src="https://gaborfarkas.github.io/assets/js/common.js"></script>


<!-- Load KaTeX -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js"></script>
<script src="https://gaborfarkas.github.io/assets/js/katex.js"></script>




<!-- Include custom icon fonts -->
<link rel="stylesheet" href="https://gaborfarkas.github.io/assets/css/font-awesome.min.css">
<link rel="stylesheet" href="https://gaborfarkas.github.io/assets/css/academicons.min.css">

<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-107151753-1', 'auto');
  ga('send', 'pageview');

</script>


  </body>

</html>

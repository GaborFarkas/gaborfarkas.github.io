<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Gábor Farkas | Switching coordinate order in OpenLayers 3</title>
  <meta name="description" content="My personal site.">

  <link rel="shortcut icon" href="https://gaborfarkas.github.io/assets/img/favicon.ico">

  <link rel="stylesheet" href="https://gaborfarkas.github.io/assets/css/main.css">
  <link rel="canonical" href="https://gaborfarkas.github.io/blog/2015/switch-coordinate-order/">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    
    <span class="site-title">
        
        Gábor Farkas
    </span>
    

    <nav class="site-nav">

      <div class="trigger">
        <!-- About -->
        <a class="page-link" href="https://gaborfarkas.github.io/">about</a>

        <!-- Blog -->
        <a class="page-link" href="https://gaborfarkas.github.io/blog/">blog</a>

        <!-- Pages -->
        
          
        
          
            <a class="page-link" href="https://gaborfarkas.github.io/cv/">CV</a>
          
        
          
        
          
        
          
            <a class="page-link" href="https://gaborfarkas.github.io/publications/">publications</a>
          
        
          
            <a class="page-link" href="https://gaborfarkas.github.io/stuff/">stuff</a>
          
        
          
        
          
        
          
        

      </div>
    </nav>

  </div>

</header>



    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Switching coordinate order in OpenLayers 3</h1>
    <p class="post-meta">August 8, 2015</p>
  </header>

  <article class="post-content">
    <link href="/assets/css/ol-v3.0.0.css" rel="stylesheet" type="text/css" />

<p>In this post we will discuss a small, but quite annoying bug/lack of feature in OpenLayers 3. Working with WFS was never one of the strengths of the library. It offers some base classes, but you have to build a complete program on it, with tons of considerations. On the top of that, you can’t easily declare the axis orientation you would like to use with your WFS request. If you have tested your WFS app with the OpenGeo demo services, you may have already bumped into this problem. Maybe, you are reading this post, because you would like to fix the issue. Well, the good news are, you can fix it manually with some JavaScript magic, but the are also some bad news. You can’t implement a simple validating system on it, as it is not version specific. From some GeoServers the coordinates in EPSG:4326 come in reverse order, while in others they are perfect with the same WFS version.</p>

<p>Let’s see the first test case. In this map, the US has taken on a journey to discover some terra incognita.</p>

<div class="map" id="map"></div>

<p>The map was produced with this simple code:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">Map</span><span class="p">({</span>
    <span class="na">target</span><span class="p">:</span> <span class="s1">'map'</span><span class="p">,</span>
    <span class="na">layers</span><span class="p">:</span> <span class="p">[</span>
        <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">Tile</span><span class="p">({</span>
            <span class="na">source</span><span class="p">:</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">TileWMS</span><span class="p">({</span>
                <span class="na">url</span><span class="p">:</span> <span class="s1">'http://demo.opengeo.org/geoserver/wms'</span><span class="p">,</span>
                <span class="na">params</span><span class="p">:</span> <span class="p">{</span>
                    <span class="na">layers</span><span class="p">:</span> <span class="s1">'bluemarble'</span><span class="p">,</span>
                    <span class="na">format</span><span class="p">:</span> <span class="s1">'image/png'</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="p">}),</span>
        <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">Vector</span><span class="p">({</span>
            <span class="na">source</span><span class="p">:</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">Vector</span><span class="p">({</span>
                <span class="na">loader</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">extent</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">proj</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
                    <span class="kd">var</span> <span class="nx">wfsParser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">WFS</span><span class="p">();</span>
                    <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
                    <span class="nx">request</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">request</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">source</span><span class="p">.</span><span class="nx">addFeatures</span><span class="p">(</span><span class="nx">wfsParser</span><span class="p">.</span><span class="nx">readFeatures</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">responseText</span><span class="p">));</span>
                        <span class="p">}</span>
                    <span class="p">};</span>
                    <span class="nx">request</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'http://demo.opengeo.org/geoserver/wfs?SERVICE=WFS&amp;REQUEST=GetFeature&amp;TYPENAME=topp:states&amp;VERSION=1.1.0&amp;SRSNAME='</span> <span class="o">+</span> <span class="nx">proj</span><span class="p">.</span><span class="nx">getCode</span><span class="p">()</span> <span class="o">+</span> <span class="s1">'&amp;BBOX='</span> <span class="o">+</span> <span class="nx">extent</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">','</span><span class="p">));</span>
                    <span class="nx">request</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="p">})</span>
    <span class="p">],</span>
    <span class="na">view</span><span class="p">:</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">View</span><span class="p">({</span>
        <span class="na">center</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="na">zoom</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="na">projection</span><span class="p">:</span> <span class="s1">'EPSG:4326'</span>
    <span class="p">})</span>
<span class="p">});</span>
</code></pre>
</div>

<p>So what is the problem with the request? We should use WFS 2.0.0 instead? No luck there. WFS 1.0.0? No luck, either (which is quite disturbing, as it has a <a href="http://docs.geoserver.org/stable/en/user/services/wfs/basics.html">reverse coordinate order</a> in the <a href="http://www.opengeospatial.org/standards/wfs">specification</a>). I couldn’t find out the reason behind this capricious behaviour of GeoServer. If you know the answer, don’t hesitate to leave a comment.</p>

<p>Now, let’s see the good news. With a little JavaScript magic, we can quite easily swap the coordinates in the parsed features.</p>

<div class="map" id="map2"></div>

<p>Now the US is safe and sound again, in the bounds of the Earth. How can you achieve the same effect? With the following modified code:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">Map</span><span class="p">({</span>
    <span class="na">target</span><span class="p">:</span> <span class="s1">'map'</span><span class="p">,</span>
    <span class="na">layers</span><span class="p">:</span> <span class="p">[</span>
        <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">Tile</span><span class="p">({</span>
            <span class="na">source</span><span class="p">:</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">TileWMS</span><span class="p">({</span>
                <span class="na">url</span><span class="p">:</span> <span class="s1">'http://demo.opengeo.org/geoserver/wms'</span><span class="p">,</span>
                <span class="na">params</span><span class="p">:</span> <span class="p">{</span>
                    <span class="na">layers</span><span class="p">:</span> <span class="s1">'bluemarble'</span><span class="p">,</span>
                    <span class="na">format</span><span class="p">:</span> <span class="s1">'image/png'</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="p">}),</span>
        <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">Vector</span><span class="p">({</span>
            <span class="na">source</span><span class="p">:</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">Vector</span><span class="p">({</span>
                <span class="na">loader</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">extent</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">proj</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
                    <span class="kd">var</span> <span class="nx">wfsParser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">WFS</span><span class="p">();</span>
                    <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
                    <span class="nx">request</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">request</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
                            <span class="kd">var</span> <span class="nx">features</span> <span class="o">=</span> <span class="nx">wfsParser</span><span class="p">.</span><span class="nx">readFeatures</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
                            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">features</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">features</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">getGeometry</span><span class="p">().</span><span class="nx">applyTransform</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">coords</span><span class="p">,</span> <span class="nx">coords2</span><span class="p">,</span> <span class="nx">stride</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">j</span><span class="o">&lt;</span><span class="nx">coords</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">j</span><span class="o">+=</span><span class="nx">stride</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">coords</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
                                        <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">coords</span><span class="p">[</span><span class="nx">j</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
                                        <span class="nx">coords</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
                                        <span class="nx">coords</span><span class="p">[</span><span class="nx">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">y</span><span class="p">;</span>
                                    <span class="p">}</span>
                                <span class="p">});</span>
                            <span class="p">}</span>
                            <span class="nx">source</span><span class="p">.</span><span class="nx">addFeatures</span><span class="p">(</span><span class="nx">features</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">};</span>
                    <span class="nx">request</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="s1">'http://demo.opengeo.org/geoserver/wfs?SERVICE=WFS&amp;REQUEST=GetFeature&amp;TYPENAME=topp:states&amp;VERSION=1.1.0&amp;SRSNAME='</span> <span class="o">+</span> <span class="nx">proj</span><span class="p">.</span><span class="nx">getCode</span><span class="p">()</span> <span class="o">+</span> <span class="s1">'&amp;BBOX='</span> <span class="o">+</span> <span class="nx">extent</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">','</span><span class="p">));</span>
                    <span class="nx">request</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="p">})</span>
    <span class="p">],</span>
    <span class="na">view</span><span class="p">:</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">View</span><span class="p">({</span>
        <span class="na">center</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="na">zoom</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="na">projection</span><span class="p">:</span> <span class="s1">'EPSG:4326'</span>
    <span class="p">})</span>
<span class="p">});</span>
</code></pre>
</div>

<h3 id="the-applytransform-method-to-the-rescue">The applyTransform method to the rescue</h3>

<p>This method is <a href="http://openlayers.org/en/v3.7.0/apidoc/ol.geom.SimpleGeometry.html#applyTransform">listed in the API</a>, however it lacks the required documentation. If you look at the source code, fortunately, you can see how it works. It gives out the internal coordinate array of a feature, which is a simple array. We can modify it in place with the function given to the method as an argument. The method gives three arguments to our function. The first two are the same coordinate array (don’t ask why), while the third is called the stride. It is a numerical representation of the layout used in the feature:</p>

<ul>
  <li>XY - 2</li>
  <li>XYZ - 3</li>
  <li>XYZM - 4</li>
</ul>

<p>It simply tells us, how much we have to increase our index in the iteration, to reach the next pair of coordinates. The rest of the function is unequivocal: we simply swap the x, and the y coordinates in place.</p>

<script src="/assets/js/ol-v3.7.0.js" type="text/javascript"></script>

<script src="/assets/js/switch-coordinate-order.js" type="text/javascript"></script>


  </article>

  
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname  = 'gaborfarkas-github-io';
      var disqus_identifier = '/blog/2015/switch-coordinate-order';
      var disqus_title      = "Switching coordinate order in OpenLayers 3";
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  

</div>

      </div>
    </div>

    <footer>

  <div class="wrapper">
    &copy; Copyright 2019 Gábor Farkas.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>.

    
  </div>

</footer>


    <!-- Load jQuery -->
<script src="//code.jquery.com/jquery-1.12.4.min.js"></script>

<!-- Load Common JS -->
<script src="https://gaborfarkas.github.io/assets/js/common.js"></script>


<!-- Load KaTeX -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js"></script>
<script src="https://gaborfarkas.github.io/assets/js/katex.js"></script>




<!-- Include custom icon fonts -->
<link rel="stylesheet" href="https://gaborfarkas.github.io/assets/css/font-awesome.min.css">
<link rel="stylesheet" href="https://gaborfarkas.github.io/assets/css/academicons.min.css">

<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-107151753-1', 'auto');
  ga('send', 'pageview');

</script>


  </body>

</html>

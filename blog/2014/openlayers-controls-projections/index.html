<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Gábor Farkas | Controls and projections in OpenLayers</title>
  <meta name="description" content="My personal site.">

  <link rel="shortcut icon" href="https://gaborfarkas.github.io/assets/img/favicon.ico">

  <link rel="stylesheet" href="https://gaborfarkas.github.io/assets/css/main.css">
  <link rel="canonical" href="https://gaborfarkas.github.io/blog/2014/openlayers-controls-projections/">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    
    <span class="site-title">
        
        Gábor Farkas
    </span>
    

    <nav class="site-nav">

      <div class="trigger">
        <!-- About -->
        <a class="page-link" href="https://gaborfarkas.github.io/">about</a>

        <!-- Blog -->
        <a class="page-link" href="https://gaborfarkas.github.io/blog/">blog</a>

        <!-- Pages -->
        
          
        
          
            <a class="page-link" href="https://gaborfarkas.github.io/cv/">CV</a>
          
        
          
        
          
        
          
            <a class="page-link" href="https://gaborfarkas.github.io/publications/">publications</a>
          
        
          
            <a class="page-link" href="https://gaborfarkas.github.io/stuff/">stuff</a>
          
        
          
        
          
        
          
        

      </div>
    </nav>

  </div>

</header>



    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Controls and projections in OpenLayers</h1>
    <p class="post-meta">December 6, 2014</p>
  </header>

  <article class="post-content">
    <style type="text/css">
    .ol-mouse-position {
        bottom: 0px;
        right: 0px;
        top: auto;
    }
    .ol_legend {
    bottom: 0px; left: 0px; position: absolute; background-color: #FFFFFF;
    }
    svg {
        max-height: initial;
    }
</style>

<link href="/assets/css/ol-v3.0.0.css" rel="stylesheet" type="text/css" />

<p>OpenLayers has a huge advantage as a Web GIS GUI over Leaflet. It can handle any projection, which can be described by Proj.4. Leaflet supports only two projections (the <a href="http://spatialreference.org/ref/epsg/4326/">WGS84</a> and the <a href="http://spatialreference.org/ref/sr-org/7483/">Web Mercator</a>). These projections are natively supported in most of the GUIs. As Leaflet is a plugin based, modular library, it has a <a href="https://github.com/kartena/Proj4Leaflet">plugin</a> to use Proj.4 capable projections, but it makes a reverse transformation. It transforms the input coordinates with Proj4js from the defined projection to geographic coordinates. OpenLayers on the other side is capable to handle any coordinate system, so the input maps will be rendered in a projection defined by the developer.</p>

<h3 id="using-local-projections">Using local projections</h3>

<p>Both of the OpenLayers libraries support projection information of the map object, and any individual layer. As vector layers get rendered on the client side, the libraries project it from the layer projection to the map projection (if defined) automatically. In OpenLayers 2, the map object also has a <code class="highlighter-rouge">displayProjection</code> parameter. It can be used to display mouse coordinates in the defined projection without projecting the map data.</p>

<p>Raster layers are harder to handle. They cannot be reprojected with the Proj.4 library, so they can only exist in one particular projection. In the case of raster layers, their CRS must be the same, the <code class="highlighter-rouge">map</code> object should know this parameter, and their respective layer objects don’t have to know about it. To define a projection, you have to provide its Proj.4 definition in the <code class="highlighter-rouge">projection</code> parameter.</p>

<p>To use a local or custom projection, the library needs the definition of it. OpenLayers 2 knows a lot of definitions natively, but in OpenLayers 3, you have to define them prior to use. Note, that the two libraries using different versions of Proj4js. With OpenLayers 2, you have to use <a href="https://trac.osgeo.org/proj4js/wiki/Download">v1.0+</a> (preferably v1.1.1), while OpenLayers 3 uses <a href="https://github.com/proj4js/proj4js/releases">v2.0+</a>. The syntax of defining projections in the two library differs. Be aware to use the correct syntax for the used version.</p>

<p>OpenLayers 2:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">Proj4js</span><span class="p">.</span><span class="nx">defs</span><span class="p">[</span><span class="s2">"EPSG:23700"</span><span class="p">]</span><span class="o">=</span><span class="s2">"+proj=somerc +lat_0=47.14439372222222 
+lon_0=19.04857177777778 +k_0=0.99993 +x_0=650000 +y_0=200000 
+ellps=GRS67 +towgs84=52.17,-71.82,-14.9,0,0,0,0 +units=m +no_defs"</span><span class="p">;</span>
</code></pre>
</div>

<p>OpenLayers 3:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">proj4</span><span class="p">.</span><span class="nx">defs</span><span class="p">(</span><span class="s2">"EPSG:23700"</span><span class="p">,</span> <span class="s2">"+proj=somerc +lat_0=47.14439372222222 
+lon_0=19.04857177777778 +k_0=0.99993 +x_0=650000 +y_0=200000 
+ellps=GRS67 +towgs84=52.17,-71.82,-14.9,0,0,0,0 +units=m +no_defs"</span><span class="p">);</span>
</code></pre>
</div>

<p>To use the defined projection in the application, you just have to include the definition name (currently EPSG:23700) in the <code class="highlighter-rouge">projection</code> parameter. You can name your projection definitions practically anything.</p>

<p>OpenLayers 2:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">ol2_map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Map</span><span class="p">(</span><span class="s1">'ol2map'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">projection</span><span class="p">:</span> <span class="s2">"EPSG:23700"</span><span class="p">,</span>
    <span class="na">restrictedExtent</span><span class="p">:</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Bounds</span><span class="p">(</span><span class="mi">400000</span><span class="p">,</span><span class="mi">45000</span><span class="p">,</span><span class="mi">950000</span><span class="p">,</span><span class="mi">380000</span><span class="p">),</span>
    <span class="na">maxResolution</span><span class="p">:</span> <span class="mi">1000</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">wms</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Layer</span><span class="p">.</span><span class="nx">WMS</span><span class="p">(</span> <span class="s2">"Administrative boundaries"</span><span class="p">,</span>
    <span class="s1">'http://mercator.elte.hu/cgi-bin/mapserv?map=/home/oktatok/saman/public_html/hu/okt/mapserver/mo.map'</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="na">layers</span><span class="p">:</span> <span class="s1">'kozig'</span><span class="p">,</span>
        <span class="na">format</span><span class="p">:</span> <span class="s1">'image/png'</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="na">maxExtent</span><span class="p">:</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Bounds</span><span class="p">(</span><span class="mi">400000</span><span class="p">,</span><span class="mi">45000</span><span class="p">,</span><span class="mi">950000</span><span class="p">,</span><span class="mi">380000</span><span class="p">),</span>
        <span class="na">singleTile</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">isBaseLayer</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="na">showLegend</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">});</span>
    
<span class="kd">var</span> <span class="nx">wms2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Layer</span><span class="p">.</span><span class="nx">WMS</span><span class="p">(</span><span class="s2">"Elevation"</span><span class="p">,</span>
    <span class="s1">'http://www.agt.bme.hu/cgi-bin/mapserv?map=/var/www/html/gis/wms/eu_dem/eu_dem.map'</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">layers</span><span class="p">:</span> <span class="s1">'mo_eov_szines'</span><span class="p">,</span>
        <span class="na">format</span><span class="p">:</span> <span class="s1">'image/png'</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="na">maxExtent</span><span class="p">:</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Bounds</span><span class="p">(</span><span class="mi">400000</span><span class="p">,</span><span class="mi">45000</span><span class="p">,</span><span class="mi">950000</span><span class="p">,</span><span class="mi">380000</span><span class="p">)</span>
<span class="p">});</span>

<span class="nx">ol2_map</span><span class="p">.</span><span class="nx">addLayers</span><span class="p">([</span><span class="nx">wms</span><span class="p">,</span> <span class="nx">wms2</span><span class="p">]);</span>

<span class="nx">ol2_map</span><span class="p">.</span><span class="nx">zoomToMaxExtent</span><span class="p">();</span>
</code></pre>
</div>

<p>OpenLayers 3:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">ol3_map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">Map</span><span class="p">({</span>
    <span class="na">target</span><span class="p">:</span> <span class="s1">'ol3map'</span><span class="p">,</span>
    <span class="na">layers</span><span class="p">:</span> <span class="p">[</span>
        <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">Tile</span><span class="p">({</span>
            <span class="na">source</span><span class="p">:</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">TileWMS</span><span class="p">({</span>
                <span class="na">url</span><span class="p">:</span> <span class="s1">'http://www.agt.bme.hu/cgi-bin/mapserv?map=/var/www/html/gis/wms/eu_dem/eu_dem.map'</span><span class="p">,</span>
                <span class="na">params</span><span class="p">:</span> <span class="p">{</span>
                    <span class="na">layers</span><span class="p">:</span> <span class="s1">'mo_eov_szines'</span><span class="p">,</span>
                    <span class="na">format</span><span class="p">:</span> <span class="s1">'image/png'</span>
                <span class="p">},</span>
                <span class="na">serverType</span><span class="p">:</span> <span class="s1">'mapserver'</span>
            <span class="p">}),</span>
            <span class="na">extent</span><span class="p">:</span> <span class="p">[</span><span class="mi">400000</span><span class="p">,</span><span class="mi">45000</span><span class="p">,</span><span class="mi">950000</span><span class="p">,</span><span class="mi">380000</span><span class="p">]</span>
        <span class="p">}),</span>
        <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">Image</span><span class="p">({</span>
            <span class="na">source</span><span class="p">:</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">ImageWMS</span><span class="p">({</span>
                <span class="na">url</span><span class="p">:</span> <span class="s1">'http://mercator.elte.hu/cgi-bin/mapserv?map=/home/oktatok/saman/public_html/hu/okt/mapserver/mo.map'</span><span class="p">,</span>
                <span class="na">params</span><span class="p">:{</span>
                    <span class="na">layers</span><span class="p">:</span> <span class="s1">'kozig'</span><span class="p">,</span>
                    <span class="na">format</span><span class="p">:</span> <span class="s1">'image/png'</span>
                <span class="p">},</span>
                <span class="na">serverType</span><span class="p">:</span> <span class="s1">'mapserver'</span>
            <span class="p">}),</span>
            <span class="na">extent</span><span class="p">:</span> <span class="p">[</span><span class="mi">400000</span><span class="p">,</span><span class="mi">45000</span><span class="p">,</span><span class="mi">950000</span><span class="p">,</span><span class="mi">380000</span><span class="p">],</span>
            <span class="na">showLegend</span><span class="p">:</span> <span class="kc">true</span>
        <span class="p">})</span>
    <span class="p">],</span>
    <span class="na">controls</span><span class="p">:</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">defaults</span><span class="p">({</span><span class="na">attribution</span><span class="p">:</span> <span class="kc">false</span><span class="p">}).</span><span class="nx">extend</span><span class="p">([</span>
        <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">MousePosition</span><span class="p">()</span>
        <span class="p">]),</span>
    <span class="na">view</span><span class="p">:</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">View</span><span class="p">({</span>
        <span class="na">center</span><span class="p">:</span> <span class="p">[</span><span class="mi">675000</span><span class="p">,</span> <span class="mi">212500</span><span class="p">],</span>
        <span class="na">zoom</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="na">projection</span><span class="p">:</span> <span class="s1">'EPSG:23700'</span><span class="p">,</span>
        <span class="na">extent</span><span class="p">:</span> <span class="p">[</span><span class="mi">400000</span><span class="p">,</span><span class="mi">45000</span><span class="p">,</span><span class="mi">950000</span><span class="p">,</span><span class="mi">380000</span><span class="p">],</span>
        <span class="na">maxResolution</span><span class="p">:</span> <span class="mi">1000</span>
    <span class="p">})</span>
<span class="p">});</span>
</code></pre>
</div>

<p>The source of the layers are now two different MapServers with a local, Hungarian projection (EPSG:23700, HD72/EOV). They only cover the area of Hungary, so they have a fixed extent, which have to be provided to the server to get the requested images. But how to get these information from a WMS server? If you know the URL to the service, you know everything. The WMS specification states, that a Web Map Service is required to answer to two request. One of them is the <a href="http://mercator.elte.hu/cgi-bin/mapserv?map=/home/oktatok/saman/public_html/hu/okt/mapserver/mo.map&amp;service=WMS&amp;request=GetCapabilities">GetCapabilities</a> request, which returns the capabilities of the current service. The returned XML contains the map extent, the available formats, and the available layers.</p>

<h3 id="adding-map-controls">Adding map controls</h3>

<p>Map controls are built-in functions to ease the use and the customization of a Web GIS application. There are very different functions, like the <code class="highlighter-rouge">LayerSwither()</code>, the <code class="highlighter-rouge">MousePosition()</code>, the <code class="highlighter-rouge">ScaleLine()</code>, or the <code class="highlighter-rouge">Rotate()</code> tool in OpenLayers 3. There are also basic, default controls, like the zoom or pan tool. Note, that if you define controls in the map object, you override the default controls, so somehow you have to include them, too in the <code class="highlighter-rouge">controls</code> parameter.</p>

<p>OpenLayers 2:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">ol2_map</span><span class="p">.</span><span class="nx">addControl</span><span class="p">(</span><span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">MousePosition</span><span class="p">());</span>
<span class="nx">ol2_map</span><span class="p">.</span><span class="nx">addControl</span><span class="p">(</span><span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">LayerSwitcher</span><span class="p">());</span>
<span class="nx">ol2_map</span><span class="p">.</span><span class="nx">addControl</span><span class="p">(</span><span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">WMSLegend</span><span class="p">({</span>
    <span class="na">class</span><span class="p">:</span> <span class="s1">'ol_legend'</span>
<span class="p">}));</span>
</code></pre>
</div>

<p>OpenLayers 3:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">ol3_map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">Map</span><span class="p">({</span>
    <span class="p">[...]</span>
    <span class="na">controls</span><span class="p">:</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">defaults</span><span class="p">({</span><span class="na">attribution</span><span class="p">:</span> <span class="kc">false</span><span class="p">}).</span><span class="nx">extend</span><span class="p">([</span>
        <span class="k">new</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">MousePosition</span><span class="p">()</span>
        <span class="p">]),</span>
    <span class="p">[...]</span>

<span class="nx">ol3_map</span><span class="p">.</span><span class="nx">addControl</span><span class="p">(</span><span class="nx">ol3_legend</span><span class="p">({</span>
    <span class="na">map</span><span class="p">:</span> <span class="nx">ol3_map</span><span class="p">,</span>
    <span class="na">class</span><span class="p">:</span> <span class="s1">'ol_legend'</span>
<span class="p">}));</span>
</code></pre>
</div>

<p>In OpenLayers 2, to add the controls in the map object, you have to add the default controls too, which are <code class="highlighter-rouge">OpenLayers.Control.Navigation()</code> and <code class="highlighter-rouge">OpenLayers.Control.Zoom()</code>. Otherwise, you have to add the new control after the map had been constructed, with the <code class="highlighter-rouge">addControl()</code> method. In OpenLayers 3, there is an <code class="highlighter-rouge">addControl()</code> method, too, however, you can extend the default controls with <code class="highlighter-rouge">ol.control.defaults.extend()</code>.</p>

<h3 id="creating-new-control">Creating new control</h3>

<p>If you look at the provided GetCapabilities request link, there is a legend service, which can be used as an image legend. For this, you can build a new <code class="highlighter-rouge">WMSLegend()</code> control, which can be parametrized for any similar service. We don’t want to include layer identifiers in it, so instead, we create a new property in the layer objects called <code class="highlighter-rouge">showLegend</code>. It will be the key of the filter to sort out the layers the control will be applied on. Furthermore, we want to use that particular map object, the control is called upon. To do this, we have to inherit the properties of the main control class. Sadly, this is bugged in OpenLayers 3.0.0, but it is fixed in the current testing version. For this reason, the OpenLayers 3 control will require the map object.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;style </span><span class="na">type=</span><span class="s">"text/css"</span><span class="nt">&gt;</span>
    <span class="nc">.ol_legend</span> <span class="p">{</span>
    <span class="nl">bottom</span><span class="p">:</span> <span class="m">0px</span><span class="p">;</span> <span class="nl">left</span><span class="p">:</span> <span class="m">0px</span><span class="p">;</span> <span class="nl">position</span><span class="p">:</span> <span class="nb">absolute</span><span class="p">;</span> <span class="nl">background-color</span><span class="p">:</span> <span class="m">#FFFFFF</span><span class="p">;</span>
    <span class="p">}</span>
<span class="nt">&lt;/style&gt;</span>
</code></pre>
</div>

<p>OpenLayers 2:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">WMSLegend</span> <span class="o">=</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Class</span><span class="p">(</span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">class</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="na">wmsVersion</span><span class="p">:</span> <span class="s1">'1.3.0'</span><span class="p">,</span>
    <span class="na">format</span><span class="p">:</span> <span class="s1">'image/png'</span><span class="p">,</span>
    <span class="na">draw</span><span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">legendP</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'p'</span><span class="p">);</span>
        <span class="nx">legendP</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'Legend:'</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'div'</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">div</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="kr">class</span> <span class="o">+</span> <span class="s1">' olControlNoSelect'</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">div</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">legendP</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">layers</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">layers</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">layers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">layers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">getOptions</span><span class="p">().</span><span class="nx">showLegend</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">legendImg</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'img'</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">layers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">params</span><span class="p">.</span><span class="nx">LAYERS</span> <span class="o">===</span> <span class="s1">'string'</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">layer</span> <span class="o">=</span> <span class="nx">layers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">params</span><span class="p">.</span><span class="nx">LAYERS</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">layer</span> <span class="o">=</span> <span class="nx">layers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">params</span><span class="p">.</span><span class="nx">LAYERS</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                <span class="p">}</span>
                <span class="nx">legendImg</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">layers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">url</span> <span class="o">+</span> <span class="s1">'&amp;version='</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">wmsVersion</span> <span class="o">+</span> <span class="s1">'&amp;service=WMS&amp;request=GetLegendGraphic&amp;sld_version=1.1.0&amp;layer='</span> <span class="o">+</span> <span class="nx">layer</span> <span class="o">+</span> <span class="s1">'&amp;format='</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">format</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">div</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">legendImg</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">div</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="na">CLASS_NAME</span><span class="p">:</span> <span class="s1">'OpenLayers.Control.WMSLegend'</span>
<span class="p">});</span>
</code></pre>
</div>

<p>OpenLayers 3:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">ol</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">WMSLegend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opt_options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">opt_options</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'div'</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">legendP</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'p'</span><span class="p">);</span>
    <span class="nx">legendP</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">'Legend:'</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="kr">class</span> <span class="o">+</span> <span class="s1">' ol-unselectable'</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">div</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">legendP</span><span class="p">);</span>
    <span class="nx">ol</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">element</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">div</span>
    <span class="p">});</span>
<span class="p">};</span>
<span class="nx">ol</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">ol</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">WMSLegend</span><span class="p">,</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">Control</span><span class="p">);</span>

<span class="nx">ol</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">WMSLegend</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">drawLegendItem</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">layer</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">layer</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'showLegend'</span><span class="p">)</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">layer</span><span class="p">.</span><span class="nx">getSource</span><span class="p">().</span><span class="nx">getUrls</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">layer</span><span class="p">.</span><span class="nx">getSource</span><span class="p">().</span><span class="nx">getUrl</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">legendImg</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'img'</span><span class="p">);</span>
        <span class="nx">legendImg</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">url</span> <span class="o">+</span> <span class="s1">'&amp;version='</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">wmsVersion</span> <span class="o">+</span> <span class="s1">'&amp;service=WMS&amp;request=GetLegendGraphic&amp;sld_version=1.1.0&amp;layer='</span> <span class="o">+</span> <span class="nx">layer</span><span class="p">.</span><span class="nx">getSource</span><span class="p">().</span><span class="nx">getParams</span><span class="p">().</span><span class="nx">layers</span> <span class="o">+</span> <span class="s1">'&amp;format='</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">format</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">div</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">legendImg</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">ol</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">WMSLegend</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setMap</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">map</span><span class="p">){</span>
    <span class="nx">ol</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setMap</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">map</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">wmsVersion</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">wmsVersion</span> <span class="o">||</span> <span class="s1">'1.3.0'</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">format</span> <span class="o">||</span> <span class="s1">'image/png'</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">layers</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">getLayers</span><span class="p">().</span><span class="nx">getArray</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">layers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">layers</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nx">ol</span><span class="p">.</span><span class="nx">layer</span><span class="p">.</span><span class="nx">Group</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">layersFromGroup</span> <span class="o">=</span> <span class="nx">layers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">getLayers</span><span class="p">().</span><span class="nx">getArray</span><span class="p">();</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">j</span><span class="o">&lt;</span><span class="nx">layersFromGroup</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">drawLegendItem</span><span class="p">(</span><span class="nx">layersFromGroup</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">drawLegendItem</span><span class="p">(</span><span class="nx">layers</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre>
</div>

<h4 id="extending-controls-in-openlayers-2">Extending controls in OpenLayers 2</h4>

<p>To make our new control inherit the properties of the main control class, we have to use <code class="highlighter-rouge">OpenLayers.Class(OpenLayers.Control, [...])</code>. This way, our control will have all the properties, <code class="highlighter-rouge">OpenLayers.Control</code> has. We have to set up every control specific variable and function as object parameters. There are three main function properties in the control class: <code class="highlighter-rouge">initialize</code>, <code class="highlighter-rouge">destroy</code>, and <code class="highlighter-rouge">draw</code>. We will only use the draw property to draw the legend. We will define the following variables: <code class="highlighter-rouge">class</code>, <code class="highlighter-rouge">wmsVersion</code>, and <code class="highlighter-rouge">format</code>. They will have an initial value, which can be overridden in the construction.</p>

<p>Note that we can access the control’s map object with <code class="highlighter-rouge">this.map</code>. We have to write every HTML element in <code class="highlighter-rouge">this.div</code>, and we have to return it in the finish. The main function is simple, we filter the layers with the <code class="highlighter-rouge">showLegend</code> property, get the desired layers, and write a WMS GetLegendGraphic request with the provided or default parameters. The control in the current state won’t support arrays of layers, it will only create a legend for the first one in the array. The last parameter of the control is the <code class="highlighter-rouge">CLASS_NAME</code>. This will make sure the control can be called with the <code class="highlighter-rouge">getLayersByClass()</code> method.</p>

<div id="ol2map" style="height: 500px; width: 700px;"></div>

<h4 id="extending-controls-in-openlayers-3">Extending controls in OpenLayers 3</h4>

<p>In OpenLayers 3, creating custom controls are a little bit different. At the object construction, the control can’t access the map’s properties yet, so we just set up the legend frame. Then we call the <code class="highlighter-rouge">ol.control.Control</code> constructor with our arguments, and set up inheritance, so it will be a proper control object. With the inheritance set up, our control will have a <code class="highlighter-rouge">setMap</code> function, which will be called after adding the control to the <code class="highlighter-rouge">map</code> object. To access the map’s layer stack, we have to extend the control’s <code class="highlighter-rouge">setMap</code> function to draw the legend. The legends’ properties are stored on construction, so we just have to access them, and create some elements for the images. Note that, for a successful initialization, we mustn’t override the original map setting functionality, and to do so, we have to call the original <code class="highlighter-rouge">ol.control.Control</code>’s <code class="highlighter-rouge">setMap</code> function with our custom control and map object as arguments. Update: thanks to @paul.py’s <a href="https://gis.stackexchange.com/questions/139008/openlayers-3-get-legend-not-working">question</a> on GIS StackExchange, I’ve found out that I didn’t take layer groups into consideration. The updated control brings in a separate <code class="highlighter-rouge">drawLegendItem</code> function, which accepts a single layer item as an argument, thus leaving the iteration to the <code class="highlighter-rouge">setMap</code> function and taking care of this problem in a nice way.</p>

<div id="ol3map" style="height: 500px; width: 700px;"></div>

<p>Special thanks to Tobias Sauerwein for sorting out my <a href="https://gis.stackexchange.com/questions/136572/openlayers-3-custom-control-doesnt-get-the-map-object">misconception</a> about creating controls in OpenLayers 3.</p>

<script src="/assets/js/OpenLayers/OpenLayers.js" type="text/javascript"></script>

<script src="/assets/js/ol-v3.0.0.js" type="text/javascript"></script>

<script src="/assets/js/proj4js_v2.3.3.js" type="text/javascript"></script>

<script src="/assets/js/proj4js_v1.1.0.js" type="text/javascript"></script>

<script src="/assets/js/openlayers-controls-projections.js" type="text/javascript"></script>


  </article>

  
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname  = 'gaborfarkas-github-io';
      var disqus_identifier = '/blog/2014/openlayers-controls-projections';
      var disqus_title      = "Controls and projections in OpenLayers";
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  

</div>

      </div>
    </div>

    <footer>

  <div class="wrapper">
    &copy; Copyright 2017 Gábor Farkas.
    Powered by <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank">GitHub Pages</a>.

    
  </div>

</footer>


    <!-- Load jQuery -->
<script src="//code.jquery.com/jquery-1.12.4.min.js"></script>

<!-- Load Common JS -->
<script src="https://gaborfarkas.github.io/assets/js/common.js"></script>


<!-- Load KaTeX -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js"></script>
<script src="https://gaborfarkas.github.io/assets/js/katex.js"></script>




<!-- Include custom icon fonts -->
<link rel="stylesheet" href="https://gaborfarkas.github.io/assets/css/font-awesome.min.css">
<link rel="stylesheet" href="https://gaborfarkas.github.io/assets/css/academicons.min.css">

<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-107151753-1', 'auto');
  ga('send', 'pageview');

</script>


  </body>

</html>
